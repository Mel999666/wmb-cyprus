<script>
/* --------------------------------- weights --------------------------------- */
const WEIGHTS = { m:0.40, o:0.25, q:0.20, p:0.15 };

/* ------------------------------- DOM handles -------------------------------- */
const elGate  = document.getElementById('gate');
const elPwd   = document.getElementById('adminPwd');
const elLoad  = document.getElementById('btnLoad');
const elCsv   = document.getElementById('btnCsv');
const elStat  = document.getElementById('status');

const elCard  = document.getElementById('resultsCard');
const elBody  = document.getElementById('tbody');
const elSum   = document.getElementById('summary');

const elJudgesCard = document.getElementById('judgesCard');
const elJudgesBody = document.getElementById('tbodyJudges');
const elJudgeCount = document.getElementById('judgeCount');

const elExplainCard = document.getElementById('explainCard');
const elExplainBody = document.getElementById('tbodyExplain');

/* --------------------------------- helpers ---------------------------------- */
const avg = a => a.length ? a.reduce((x,y)=>x+y,0)/a.length : 0;
const to2 = n => Number(n || 0).toFixed(2);
const byNum = (a,b) => a-b;

/** Ensure we always get clean numeric scores, never NaN */
function cleanScore(raw) {
  const s = raw || {};
  const m = Number(s.m);
  const o = Number(s.o);
  const q = Number(s.q);
  const p = Number(s.p);
  return {
    m: Number.isFinite(m) ? m : 0,
    o: Number.isFinite(o) ? o : 0,
    q: Number.isFinite(q) ? q : 0,
    p: Number.isFinite(p) ? p : 0,
  };
}

const readiness = s => {
  const c = cleanScore(s);
  return c.m*WEIGHTS.m + c.o*WEIGHTS.o + c.q*WEIGHTS.q + c.p*WEIGHTS.p;
};

/* ---------- rank each judge’s sheet (1 = best within that judge) ----------- */
function perJudgeRanking(scoresByBand){
  const entries = Object.entries(scoresByBand || {}).map(([band,s]) => ({
    band,
    r: readiness(s || {}),
  }));
  entries.sort((a,b)=> b.r - a.r);
  const out = {};
  entries.forEach((e,i)=> { out[e.band] = i+1; });
  return out;
}

/* --------- combine across judges, compute deciding metrics + counts --------- */
/* Final ordering is readiness-first; ranks are tie-breakers and for explanation */
function combineWithCounts(judgesObj){
  const perJudge = {};
  for (const [judge, sheet] of Object.entries(judgesObj || {})) {
    perJudge[judge] = perJudgeRanking(sheet.scores || {});
  }

  // collect band set
  const bands = new Set();
  Object.values(judgesObj || {}).forEach(s=>{
    Object.keys(s.scores || {}).forEach(b=>bands.add(b));
  });

  const rows = [];
  for (const band of bands) {
    const ranks=[], Ms=[],Os=[],Qs=[],Ps=[], Rs=[];
    let top6=0, top2=0;

    for (const [judge, sheet] of Object.entries(judgesObj || {})) {
      const raw = sheet.scores?.[band];
      if (!raw) continue;

      const s = cleanScore(raw);
      const rnk = perJudge[judge]?.[band];
      if (!rnk) continue;

      ranks.push(rnk);
      if (rnk<=6) top6++;
      if (rnk<=2) top2++;

      Ms.push(s.m);
      Os.push(s.o);
      Qs.push(s.q);
      Ps.push(s.p);
      Rs.push(readiness(s));
    }

    const med = ranks.length ? ranks.slice().sort(byNum)[Math.floor((ranks.length-1)/2)] : 0;
    const ar  = avg(ranks);

    rows.push({
      band,
      medianRank: med,
      avgRank: ar,
      m: avg(Ms), o: avg(Os), q: avg(Qs), p: avg(Ps),
      readiness: avg(Rs),
      judges: ranks.length,
      top6,
      top2
    });
  }

  // final ordering = highest average readiness first,
  // using rank metrics only as tie-breakers.
  rows.sort((a,b)=>{
    if (a.readiness  !== b.readiness ) return b.readiness  - a.readiness; // higher readiness = better
    if (a.medianRank !== b.medianRank) return a.medianRank - b.medianRank; // then lower median rank
    if (a.avgRank    !== b.avgRank   ) return a.avgRank    - b.avgRank;    // then lower average rank
    return a.band.localeCompare(b.band);
  });

  return rows;
}

/* ---------- build printable HTML for a single judge's card (admin view) ----- */
function makePrintableHtml(judgeName, scores){
  const rows = Object.entries(scores || {}).map(([band, s])=>{
    const c = cleanScore(s);
    const r = readiness(c);
    const cmt = (s.c || '').trim();
    return { band, ...c, r, cmt };
  }).sort((a,b)=> b.r - a.r);

  const lines = rows.map(r =>
    `<tr>
      <td>${escapeHtml(r.band)}</td>
      <td>${r.m}</td>
      <td>${r.o}</td>
      <td>${r.q}</td>
      <td>${r.p}</td>
      <td><b>${to2(r.r)}</b></td>
      <td>${escapeHtml(r.cmt)}</td>
    </tr>`
  ).join('');

  return `
<!doctype html><html><head><meta charset="utf-8">
<title>WMB Scoring — ${escapeHtml(judgeName || '')}</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;padding:20px;color:#111}
  h1{margin:0 0 6px}
  .muted{color:#555}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid #ccc;padding:6px 8px;text-align:left}
  thead th{background:#f3f3f3}
</style></head><body>
<h1>Wacken Metal Battle Cyprus — Judge sheet</h1>
<div class="muted">Judge: ${escapeHtml(judgeName || '')}</div>
<table>
  <thead>
    <tr>
      <th>Band</th>
      <th>M</th>
      <th>O</th>
      <th>Q</th>
      <th>P</th>
      <th>Readiness</th>
      <th>Comments</th>
    </tr>
  </thead>
  <tbody>${lines}</tbody>
</table>
<script>window.addEventListener('load',()=>{window.print();});<\/script>
</body></html>`;
}

/* simple HTML escaping for printable view */
function escapeHtml(s){
  return String(s || '')
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#39;');
}

/* ------------------------------ render judges ------------------------------- */
function renderJudges(entries){
  elJudgeCount.textContent = `Loaded ${entries.length} submission(s).`;
  elJudgesBody.innerHTML = entries.map(e=>{
    const d = e.ts ? new Date(e.ts).toLocaleString() : '';
    const bands = Object.keys(e.scores||{}).length;
    const judgeKey = e.judgekey || '';
    return `<tr>
      <td>${e.judge||judgeKey}</td>
      <td>${d}</td>
      <td>${bands} bands scored</td>
      <td>
        <button data-view="${judgeKey}">View card</button>
        <button data-del="${judgeKey}">Delete</button>
      </td>
    </tr>`;
  }).join('');

  // bind view card
  elJudgesBody.querySelectorAll('button[data-view]').forEach(btn=>{
    btn.onclick = ()=>{
      const judgekey = btn.getAttribute('data-view');
      const entry = entries.find(e => (e.judgekey || '') === judgekey);
      if (!entry) {
        alert('Could not find this judge submission.');
        return;
      }
      const judgeName = entry.judge || entry.judgekey || judgekey;
      const html = makePrintableHtml(judgeName, entry.scores || {});
      const blob = new Blob([html], {type:'text/html;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const w = window.open(url, '_blank');
      if (!w) {
        const a = document.createElement('a');
        a.href = url;
        a.download = `wmb_${judgekey}.html`;
        document.body.appendChild(a);
        a.click();
        a.remove();
      }
    };
  });

  // bind delete
  elJudgesBody.querySelectorAll('button[data-del]').forEach(btn=>{
    btn.onclick = async ()=>{
      if (!confirm('Delete this judge submission?')) return;
      const judgekey = btn.getAttribute('data-del');
      const pwd = elPwd.value.trim();
      const r = await fetch('/api/delete-score', {
        method:'POST',
        headers:{'content-type':'application/json'},
        body: JSON.stringify({ password: pwd, judgekey })
      });
      const t = await r.text();
      if (!r.ok) { try{ alert(JSON.parse(t).error) }catch{ alert('Delete failed') } ; return; }
      loadResults(); // refresh
    };
  });
}

/* --------------------------- render main results ---------------------------- */
function renderResults(judgesObj){
  const rows = combineWithCounts(judgesObj);

  elBody.innerHTML = rows.map((r,idx)=>`
    <tr>
      <td>${idx+1}. ${r.band}</td>
      <td class="right">${to2(r.m)}</td>
      <td class="right">${to2(r.o)}</td>
      <td class="right">${to2(r.q)}</td>
      <td class="right">${to2(r.p)}</td>

      <td class="right col-median">${to2(r.medianRank)}</td>
      <td class="right col-avgrank">${to2(r.avgRank)}</td>
      <td class="right col-readiness">${to2(r.readiness)}</td>
      <td class="right">${r.judges}</td>
    </tr>
  `).join('');

  elSum.textContent = rows.length
    ? `Top 6 by final ordering: ${rows.slice(0,6).map(r=>r.band).join(', ')}.`
    : 'No scores found yet.';

  elCard.classList.remove('hidden');

  // explanation table
  elExplainBody.innerHTML = rows.map((r, i)=>{
    const eligible =
      (r.top2 >= 3) ? '<span class="tag ok">Passion eligible</span>' :
      (r.top6 >= 3) ? '<span class="tag ok">Consensus eligible</span>' :
      '<span class="tag">None</span>';

    return `<tr>
      <td class="right">${i+1}</td>
      <td>${r.band}</td>
      <td class="right col-median">${to2(r.medianRank)}</td>
      <td class="right col-avgrank">${to2(r.avgRank)}</td>
      <td class="right col-readiness">${to2(r.readiness)}</td>
      <td class="right">${r.top6}</td>
      <td class="right">${r.top2}</td>
      <td>${eligible}</td>
    </tr>`;
  }).join('');
  elExplainCard.classList.remove('hidden');
}

/* ------------------------------ CSV download -------------------------------- */
function downloadCsv(judgesObj){
  const lines = [];
  lines.push(['judge','band','musicianship','originality','material_quality','online_presence','readiness'].join(','));
  for (const [judge, sheet] of Object.entries(judgesObj||{})) {
    const scores = sheet?.scores || {};
    for (const [band, v] of Object.entries(scores)) {
      const c = cleanScore(v);
      const r = readiness(c);
      lines.push([
        `"${judge.replace(/"/g,'""')}"`,
        `"${band.replace(/"/g,'""')}"`,
        to2(c.m), to2(c.o), to2(c.q), to2(c.p), to2(r)
      ].join(','));
    }
  }
  const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='wmb-results.csv'; a.click();
  URL.revokeObjectURL(url);
}

/* ---------------------------------- load ------------------------------------ */
async function loadResults(){
  elCsv.classList.add('hidden');
  elCard.classList.add('hidden');
  elJudgesCard.classList.add('hidden');
  elExplainCard.classList.add('hidden');
  elStat.textContent = 'Loading…';

  const pwd = elPwd.value.trim();
  const res = await fetch('/api/get-scores?__=' + Date.now(), {
    method:'POST',
    headers:{'content-type':'application/json'},
    body: JSON.stringify({ password: pwd })
  });

  const text = await res.text();
  if (!res.ok) {
    let msg = 'Auth failed or server error.';
    try { msg = JSON.parse(text).error || msg; } catch {}
    alert(msg);
    elStat.textContent = '';
    return;
  }

  let data = {};
  try { data = JSON.parse(text); } catch {}
  const judges  = data.judges  || {};
  const entries = data.entries || [];

  // hide the gate after successful load
  elGate.classList.add('hidden');
  elStat.textContent = '';

  renderResults(judges);
  renderJudges(entries);

  elCsv.classList.remove('hidden');
  elCsv.onclick = () => downloadCsv(judges);
  elJudgesCard.classList.remove('hidden');
}

elLoad.addEventListener('click', loadResults);
</script>
