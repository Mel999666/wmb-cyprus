<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Judging Results — Wacken Metal Battle Cyprus</title>
<style>
  :root{
    --bg:#0a0a0b; --panel:#151215; --text:#f2f2f2; --muted:#b8b6bb; --crimson:#b3121f;
    /* callout backgrounds for the 3 deciding columns */
    --median-bg: rgba(255,180,0,.10);   /* warm amber */
    --avgrank-bg: rgba(64,160,255,.12); /* calm blue */
    --readiness-bg: rgba(179,18,31,.14);/* maroon wash */
  }
  *{box-sizing:border-box}
  body{margin:0;background:#0a0a0b;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
  header{position:sticky;top:0;background:#0d0b0d;border-bottom:1px solid #231a1d}
  .container{max-width:1140px;margin:0 auto;padding:16px 20px}
  .card{background:linear-gradient(180deg,#181316,#110f10);border:1px solid #2b2023;border-radius:14px;padding:16px;margin:18px 0}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:#1a1416;border:1px solid #2b2023;color:var(--muted);font-size:13px}
  input,button{font:inherit}
  input[type=password]{background:#120f10;border:1px solid #2b2023;border-radius:10px;color:var(--text);padding:10px 12px;min-width:260px}
  button{background:#1a1416;border:1px solid #2b2023;color:#ffefe9;border-radius:10px;padding:10px 14px;cursor:pointer}
  button.primary{background:#b3121f;border-color:#b3121f}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px 12px;border-bottom:1px solid #2b2023}
  thead th{font-size:13px;text-transform:uppercase;letter-spacing:.35px;color:#ffefe9;background:linear-gradient(180deg,rgba(179,18,31,.22),rgba(139,15,23,.08))}
  .meta{color:var(--muted);font-size:13px}
  .right{text-align:right}
  .hidden{display:none}
  .boldwhite{font-weight:800;color:#fff;font-size:18px}

  /* Make the deciding columns pop (both header and cells) */
  th.col-median,     td.col-median{background:var(--median-bg)}
  th.col-avgrank,    td.col-avgrank{background:var(--avgrank-bg)}
  th.col-readiness,  td.col-readiness{background:var(--readiness-bg);font-weight:800}

  /* Explanation table small notes */
  .note{color:var(--muted);font-size:12px}
  .tag{display:inline-block;border:1px solid #2b2023;border-radius:999px;padding:2px 8px;font-size:12px;background:#1a1416}
  .tag.ok{border-color:#2a6b3a;background:#16331e;color:#b8f0c8}
</style>
</head>
<body>
<header>
  <div class="container">
    <h2 style="margin:0 0 8px">Judging Results — Wacken Metal Battle Cyprus</h2>

    <!-- PASSWORD GATE -->
    <div id="gate" class="card" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <input id="adminPwd" type="password" autocomplete="current-password" placeholder="Admin / results password" />
      <button id="btnLoad" class="primary">Load results</button>
      <span id="status" class="meta"></span>
    </div>

    <!-- CSV button only after load -->
    <div style="display:flex;justify-content:flex-end">
      <button id="btnCsv" class="hidden">Download Combined CSV</button>
    </div>
  </div>
</header>

<main class="container">
  <!-- MAIN RESULTS -->
  <section id="resultsCard" class="card hidden">
    <div id="summary" class="boldwhite" style="margin-bottom:10px"></div>
    <div style="overflow:auto">
      <table aria-label="Results table" id="tbl">
        <thead>
          <tr>
            <th>Band</th>
            <th class="right">Avg Musician­ship</th>
            <th class="right">Avg Originality</th>
            <th class="right">Avg Material</th>
            <th class="right">Avg Presence</th>

            <!-- the 3 deciding columns at the end, before Judges -->
            <th class="right col-median">Median rank</th>
            <th class="right col-avgrank">Avg rank</th>
            <th class="right col-readiness">Avg readiness</th>
            <th class="right">Judges</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>

  <!-- JUDGE SUBMISSIONS -->
  <section id="judgesCard" class="card hidden">
    <div class="h3" style="font-weight:700;margin:0 0 8px">Judge Submissions</div>
    <div class="meta" id="judgeCount"></div>
    <div style="overflow:auto;margin-top:8px">
      <table aria-label="Judge submissions" id="tblJudges">
        <thead>
          <tr><th>Judge</th><th>Date</th><th>Details</th><th>Actions</th></tr>
        </thead>
        <tbody id="tbodyJudges"></tbody>
      </table>
    </div>
  </section>

  <!-- EXPLANATION TEXT (you already had this) -->
  <section class="card" id="how-card">
    <div class="h3" style="font-weight:700;margin:0 0 10px">How these results are calculated</div>
    <ul>
     <ul>
  <li>Each judge scores every band in four categories:</li>
  <ul>
    <li>Musicianship (40%)</li>
    <li>Originality (25%)</li>
    <li>Material quality (20%)</li>
    <li>Stage or online presence (15%)</li>
  </ul>
  <li>These percentages are combined into a single readiness score for each band per judge.</li>

  <li><b>Step 1: Normalizing scores</b> — Judges vary in how strict or generous they are, so we convert all scores into ranks.  
  Each judge’s favourite band gets rank 1, the next gets rank 2, and so on. This ensures every judge’s opinion carries equal weight.</li>

  <li><b>Step 2: Combining ranks across judges</b> — We calculate:</li>
  <ul>
    <li><b>Median rank</b> (the middle value) — main measure of shared consensus.</li>
    <li><b>Average rank</b> — used as a tiebreaker when median ranks are the same.</li>
    <li><b>Average readiness</b> — shown for transparency, only used if the others are identical.</li>
  </ul>
  <li>Lower ranks indicate stronger overall placement.</li>

  <li><b>Step 3: Guardrails</b> — Two additional checks ensure both consensus and standout passion are respected:</li>
  <ul>
    <li><b>Consensus rule:</b> If a band appears in the top 6 of at least three judges, they outrank bands that do not.</li>
    <li><b>Passion rule:</b> If a band is ranked 1st or 2nd by at least three judges, they are guaranteed a top-6 position.</li>
  </ul>

  <li><b>Step 4: Final order</b> — Bands are ordered using the following hierarchy:</li>
  <ul>
    <li>Median rank</li>
    <li>Average rank</li>
    <li>Average readiness</li>
    <li>Guardrail eligibility (if triggered)</li>
  </ul>

  <li>This method balances collective agreement and standout performances while keeping the process transparent and fair.</li>
</ul>

    </ul>
  </section>

  <!-- NEW: EXPLANATION TABLE -->
  <section id="explainCard" class="card hidden">
    <div class="h3" style="font-weight:700;margin:0 0 10px">Explanation table</div>
    <div class="note" style="margin:-6px 0 10px">
      Shows the three deciding metrics per band plus how many judges put them in the Top-6 or Top-2.  
      “Eligible” means a guardrail could apply (your current ordering is rank-based; this is for transparency).
    </div>
    <div style="overflow:auto">
      <table aria-label="Explanation table" id="tblExplain">
        <thead>
          <tr>
            <th>#</th>
            <th>Band</th>
            <th class="right col-median">Median rank</th>
            <th class="right col-avgrank">Avg rank</th>
            <th class="right col-readiness">Avg readiness</th>
            <th class="right">Top-6 votes</th>
            <th class="right">Top-2 votes</th>
            <th>Guardrail eligibility</th>
          </tr>
        </thead>
        <tbody id="tbodyExplain"></tbody>
      </table>
    </div>
  </section>
</main>

<script>
/* --------------------------------- weights --------------------------------- */
const WEIGHTS = { m:0.40, o:0.25, q:0.20, p:0.15 };

/* ------------------------------- DOM handles -------------------------------- */
const elGate  = document.getElementById('gate');
const elPwd   = document.getElementById('adminPwd');
const elLoad  = document.getElementById('btnLoad');
const elCsv   = document.getElementById('btnCsv');
const elStat  = document.getElementById('status');

const elCard  = document.getElementById('resultsCard');
const elBody  = document.getElementById('tbody');
const elSum   = document.getElementById('summary');

const elJudgesCard = document.getElementById('judgesCard');
const elJudgesBody = document.getElementById('tbodyJudges');
const elJudgeCount = document.getElementById('judgeCount');

const elExplainCard = document.getElementById('explainCard');
const elExplainBody = document.getElementById('tbodyExplain');

/* --------------------------------- helpers ---------------------------------- */
const readiness = s => s.m*WEIGHTS.m + s.o*WEIGHTS.o + s.q*WEIGHTS.q + s.p*WEIGHTS.p;
const avg = a => a.length ? a.reduce((x,y)=>x+y,0)/a.length : 0;
const to2 = n => Number(n).toFixed(2);
const byNum = (a,b) => a-b;

/* ---------- rank each judge’s sheet (1 = best within that judge) ----------- */
function perJudgeRanking(scoresByBand){
  const entries = Object.entries(scoresByBand).map(([band,s])=>({ band, r: readiness(s) }));
  entries.sort((a,b)=> b.r - a.r);
  const out = {};
  entries.forEach((e,i)=> out[e.band] = i+1);
  return out;
}

/* --------- combine across judges, compute deciding metrics + counts --------- */
function combineWithCounts(judgesObj){
  const perJudge = {};
  for (const [judge, sheet] of Object.entries(judgesObj||{})) {
    perJudge[judge] = perJudgeRanking(sheet.scores||{});
  }

  // collect band set
  const bands = new Set();
  Object.values(judgesObj||{}).forEach(s=>{
    Object.keys(s.scores||{}).forEach(b=>bands.add(b));
  });

  const rows = [];
  for (const band of bands) {
    const ranks=[], Ms=[],Os=[],Qs=[],Ps=[], Rs=[];
    let top6=0, top2=0;

    for (const [judge, sheet] of Object.entries(judgesObj)) {
      const s = sheet.scores?.[band];
      if (!s) continue;
      const rnk = perJudge[judge][band];
      ranks.push(rnk);
      if (rnk<=6) top6++;
      if (rnk<=2) top2++;
      Ms.push(s.m); Os.push(s.o); Qs.push(s.q); Ps.push(s.p); Rs.push(readiness(s));
    }

    const med = ranks.length ? ranks.sort(byNum)[Math.floor((ranks.length-1)/2)] : 0;
    const ar  = avg(ranks);

    rows.push({
      band,
      medianRank: med,
      avgRank: ar,
      m: avg(Ms), o: avg(Os), q: avg(Qs), p: avg(Ps),
      readiness: avg(Rs),
      judges: ranks.length,
      top6,
      top2
    });
  }

  // sort by the deciding order
  rows.sort((a,b)=>{
    if (a.medianRank !== b.medianRank) return a.medianRank - b.medianRank;
    if (a.avgRank    !== b.avgRank   ) return a.avgRank    - b.avgRank;
    if (a.readiness  !== b.readiness ) return b.readiness  - a.readiness;
    return a.band.localeCompare(b.band);
  });

  return rows;
}

/* ------------------------------ render judges ------------------------------- */
function renderJudges(entries){
  elJudgeCount.textContent = `Loaded ${entries.length} submission(s).`;
  elJudgesBody.innerHTML = entries.map(e=>{
    const d = e.ts ? new Date(e.ts).toLocaleString() : '';
    const bands = Object.keys(e.scores||{}).length;
    return `<tr>
      <td>${e.judge||e.judgekey}</td>
      <td>${d}</td>
      <td>${bands} bands scored</td>
      <td><button data-del="${e.judgekey}">Delete</button></td>
    </tr>`;
  }).join('');

  // bind delete
  elJudgesBody.querySelectorAll('button[data-del]').forEach(btn=>{
    btn.onclick = async ()=>{
      if (!confirm('Delete this judge submission?')) return;
      const judgekey = btn.getAttribute('data-del');
      const pwd = elPwd.value.trim();
      const r = await fetch('/api/delete-score', {
        method:'POST',
        headers:{'content-type':'application/json'},
        body: JSON.stringify({ password: pwd, judgekey })
      });
      const t = await r.text();
      if (!r.ok) { try{ alert(JSON.parse(t).error) }catch{ alert('Delete failed') } ; return; }
      loadResults(); // refresh
    };
  });
}

/* --------------------------- render main results ---------------------------- */
function renderResults(judgesObj){
  const rows = combineWithCounts(judgesObj);

  elBody.innerHTML = rows.map((r,idx)=>`
    <tr>
      <td>${idx+1}. ${r.band}</td>
      <td class="right">${to2(r.m)}</td>
      <td class="right">${to2(r.o)}</td>
      <td class="right">${to2(r.q)}</td>
      <td class="right">${to2(r.p)}</td>

      <td class="right col-median">${to2(r.medianRank)}</td>
      <td class="right col-avgrank">${to2(r.avgRank)}</td>
      <td class="right col-readiness">${to2(r.readiness)}</td>
      <td class="right">${r.judges}</td>
    </tr>
  `).join('');

  elSum.textContent = rows.length
    ? `Top 6 by final ordering: ${rows.slice(0,6).map(r=>r.band).join(', ')}.`
    : 'No scores found yet.';

  elCard.classList.remove('hidden');

  // explanation table
  elExplainBody.innerHTML = rows.map((r, i)=>{
    const eligible =
      (r.top2 >= 3) ? '<span class="tag ok">Passion eligible</span>' :
      (r.top6 >= 3) ? '<span class="tag ok">Consensus eligible</span>' :
      '<span class="tag">None</span>';

    return `<tr>
      <td class="right">${i+1}</td>
      <td>${r.band}</td>
      <td class="right col-median">${to2(r.medianRank)}</td>
      <td class="right col-avgrank">${to2(r.avgRank)}</td>
      <td class="right col-readiness">${to2(r.readiness)}</td>
      <td class="right">${r.top6}</td>
      <td class="right">${r.top2}</td>
      <td>${eligible}</td>
    </tr>`;
  }).join('');
  elExplainCard.classList.remove('hidden');
}

/* ------------------------------ CSV download -------------------------------- */
function downloadCsv(judgesObj){
  const lines = [];
  lines.push(['judge','band','musicianship','originality','material_quality','online_presence','readiness'].join(','));
  for (const [judge, sheet] of Object.entries(judgesObj||{})) {
    const scores = sheet?.scores || {};
    for (const [band, v] of Object.entries(scores)) {
      const r = readiness(v);
      lines.push([
        `"${judge.replace(/"/g,'""')}"`,
        `"${band.replace(/"/g,'""')}"`,
        to2(v.m||0), to2(v.o||0), to2(v.q||0), to2(v.p||0), to2(r)
      ].join(','));
    }
  }
  const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='wmb-results.csv'; a.click();
  URL.revokeObjectURL(url);
}

/* ---------------------------------- load ------------------------------------ */
async function loadResults(){
  elCsv.classList.add('hidden');
  elCard.classList.add('hidden');
  elJudgesCard.classList.add('hidden');
  elExplainCard.classList.add('hidden');
  elStat.textContent = 'Loading…';

  const pwd = elPwd.value.trim();
  const res = await fetch('/api/get-scores?__=' + Date.now(), {
    method:'POST',
    headers:{'content-type':'application/json'},
    body: JSON.stringify({ password: pwd })
  });

  const text = await res.text();
  if (!res.ok) {
    let msg = 'Auth failed or server error.';
    try { msg = JSON.parse(text).error || msg; } catch {}
    alert(msg);
    elStat.textContent = '';
    return;
  }

  let data = {};
  try { data = JSON.parse(text); } catch {}
  const judges  = data.judges  || {};
  const entries = data.entries || [];

  // hide the gate after successful load
  elGate.classList.add('hidden');
  elStat.textContent = '';

  renderResults(judges);
  renderJudges(entries);

  elCsv.classList.remove('hidden');
  elCsv.onclick = () => downloadCsv(judges);
  elJudgesCard.classList.remove('hidden');
}

document.getElementById('btnLoad').addEventListener('click', loadResults);
</script>
</body>
</html>
