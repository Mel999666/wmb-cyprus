<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>WMB Cyprus — Results</title>
<link rel="icon" href="/public/wmb-logo.jpg" />
<style>
  :root{--bg:#0a0a0b;--panel:#151215;--text:#f2f2f2;--muted:#b8b6bb;--accent:#b3121f;--border:#2b2023}
  *{box-sizing:border-box} body{margin:0;background:linear-gradient(180deg,#0d0b0d,#080708);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
  header{border-bottom:1px solid var(--border);background:rgba(10,10,11,.85);backdrop-filter:blur(8px)}
  .container{max-width:1100px;margin:0 auto;padding:16px}
  h1{margin:0;font-size:clamp(20px,4vw,28px)}
  .card{background:linear-gradient(180deg,#181316,#110f10);border:1px solid var(--border);border-radius:14px;padding:16px;margin-top:16px}
  .note{color:var(--muted);font-size:13px}
  table{width:100%;border-collapse:collapse;font-size:14px;margin-top:10px}
  th,td{border-bottom:1px solid var(--border);padding:10px;vertical-align:top}
  thead th{background:#120f10}
  .btn{border:1px solid var(--border);background:var(--accent);color:#fff;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
  .grid{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
</style>
</head>
<body>
<header><div class="container"><h1>Judging Results — Wacken Metal Battle Cyprus</h1></div></header>

<main class="container">
  <div class="card">
    <div class="grid">
      <input type="password" id="adminPass" placeholder="Admin password" />
      <button class="btn" id="loadBtn">Load results</button>
      <button class="btn" id="downloadBtn" disabled>Download Combined CSV</button>
    </div>
    <div class="note">Loads all judges’ saved sheets from the server and computes the Top 6 by average Wacken Readiness.</div>
  </div>

  <div class="card" id="top6Card" style="display:none">
    <h3 style="margin:0 0 10px">Top 6 by Average Wacken Readiness</h3>
    <table id="top6">
      <thead><tr><th>#</th><th>Band</th><th>Average</th><th>Judge Count</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="card" id="allCard" style="display:none">
    <h3 style="margin:0 0 10px">All Bands — Averages</h3>
    <table id="all">
      <thead><tr><th>Band</th><th>Average</th><th>Judges</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</main>

<script>
  let combined = []; // {band, avg, judges}
  document.getElementById("loadBtn").addEventListener("click", load);

  async function load(){
    const password = (document.getElementById("adminPass").value || "").trim();
    if(!password){ alert("Enter the admin password."); return; }

    const r = await fetch(`/api/get-scores?password=${encodeURIComponent(password)}`);
    if(!r.ok){ alert("Auth failed or server error."); return; }
    const j = await r.json();
    const rows = [];

    // j.data = [{ judge, scores: { BandName: {mus, orig, material, presence, notes, total}, ... } }, ...]
    for(const entry of j.data){
      for(const [band, s] of Object.entries(entry.scores)){
        rows.push({ band, total: +s.total || 0 });
      }
    }

    // group by band and average
    const byBand = {};
    for(const row of rows){
      if(!byBand[row.band]) byBand[row.band] = [];
      byBand[row.band].push(row.total);
    }

    combined = Object.entries(byBand).map(([band, arr])=>{
      const avg = arr.reduce((a,b)=>a+b,0) / arr.length;
      return { band, avg, judges: arr.length };
    }).sort((a,b)=>b.avg - a.avg);

    // render Top 6
    const topBody = document.querySelector("#top6 tbody");
    topBody.innerHTML = combined.slice(0,6).map((r,i)=>`
      <tr><td>${i+1}</td><td>${r.band}</td><td>${r.avg.toFixed(2)}</td><td>${r.judges}</td></tr>
    `).join("");
    document.getElementById("top6Card").style.display = "";

    // render all
    const allBody = document.querySelector("#all tbody");
    allBody.innerHTML = combined.map(r=>`
      <tr><td>${r.band}</td><td>${r.avg.toFixed(2)}</td><td>${r.judges}</td></tr>
    `).join("");
    document.getElementById("allCard").style.display = "";

    document.getElementById("downloadBtn").disabled = false;
  }

  document.getElementById("downloadBtn").addEventListener("click", ()=>{
    const header = ["Band","AverageWackenReadiness","JudgeCount"];
    const lines = [header.join(",")];
    combined.forEach(r=>lines.push([csv(r.band), r.avg.toFixed(2), r.judges].join(",")));
    const blob = new Blob([lines.join("\n")], {type:"text/csv"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "wmb-combined-averages.csv";
    a.click();
  });

  function csv(val){ const v=(val??"").toString().replace(/"/g,'""'); return `"${v}"`; }
</script>
</body>
</html>
