<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Judging Results — Wacken Metal Battle Cyprus</title>
<style>
  :root{--bg:#0a0a0b;--panel:#151215;--text:#f2f2f2;--muted:#b8b6bb;--crimson:#b3121f}
  *{box-sizing:border-box}
  body{margin:0;background:#0a0a0b;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
  header{position:sticky;top:0;background:#0d0b0d;border-bottom:1px solid #231a1d}
  .container{max-width:1140px;margin:0 auto;padding:16px 20px}
  .card{background:linear-gradient(180deg,#181316,#110f10);border:1px solid #2b2023;border-radius:14px;padding:16px;margin:18px 0}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:#1a1416;border:1px solid #2b2023;color:var(--muted);font-size:13px}
  input,button{font:inherit}
  input[type=password]{background:#120f10;border:1px solid #2b2023;border-radius:10px;color:var(--text);padding:10px 12px;min-width:260px}
  button{background:#1a1416;border:1px solid #2b2023;color:#ffefe9;border-radius:10px;padding:10px 14px;cursor:pointer}
  button.primary{background:#b3121f;border-color:#b3121f}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px 12px;border-bottom:1px solid #2b2023}
  thead th{font-size:13px;text-transform:uppercase;letter-spacing:.35px;color:#ffefe9;background:linear-gradient(180deg,rgba(179,18,31,.22),rgba(139,15,23,.08))}
  .meta{color:var(--muted);font-size:13px}
  .right{text-align:right}
  .hidden{display:none}
  .boldwhite{font-weight:800;color:#fff;font-size:18px}
  td.readiness{background:rgba(179,18,31,.12);font-weight:800}
</style>
</head>
<body>
<header>
  <div class="container">
    <h2 style="margin:0 0 8px">Judging Results — Wacken Metal Battle Cyprus</h2>
    <div id="gate" class="card" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <input id="adminPwd" type="password" autocomplete="current-password" placeholder="Admin / results password" />
      <button id="btnLoad" class="primary">Load results</button>
      <span id="status" class="meta"></span>
    </div>
    <div id="csvWrap" class="hidden" style="display:flex;justify-content:flex-end">
      <button id="btnCsv">Download Combined CSV</button>
    </div>
  </div>
</header>

<main class="container">
  <section id="resultsCard" class="card hidden">
    <div id="summary" class="boldwhite" style="margin-bottom:10px"></div>
    <div style="overflow:auto">
      <table aria-label="Results table" id="tbl">
        <thead>
          <tr>
            <th>Band</th>
            <th class="right">Median rank</th>
            <th class="right">Avg rank</th>
            <th class="right">Avg Musicianship</th>
            <th class="right">Avg Originality</th>
            <th class="right">Avg Material</th>
            <th class="right">Avg Presence</th>
            <th class="right">Avg Readiness</th>
            <th class="right">Judges</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>

  <section id="judgesCard" class="card hidden">
    <div class="h3" style="font-weight:700;margin:0 0 8px">Judge Submissions</div>
    <div class="meta" id="judgeCount"></div>
    <div style="overflow:auto;margin-top:8px">
      <table aria-label="Judge submissions" id="tblJudges">
        <thead>
          <tr><th>Judge</th><th>Date</th><th>Details</th><th>Actions</th></tr>
        </thead>
        <tbody id="tbodyJudges"></tbody>
      </table>
    </div>
  </section>

  <section id="explainCard" class="card hidden">
    <div class="h3" style="font-weight:700;margin:0 0 10px">How these results are calculated</div>
    <ul>
      <li>Each judge scores every band: Musicianship 40 percent, Originality 25 percent, Online Material Quality 20 percent, Online Presence 15 percent. These weights produce a judge’s single “readiness” score per band.</li>
      <li>We convert each judge’s scores into a <em>ranking of bands</em>. This removes differences in how strict or generous a judge is.</li>
      <li>We order bands by their <b>median rank</b> across judges. The median is robust to one wild view and represents shared consensus.</li>
      <li>Tie-breakers: average rank, a trimmed standardized average of readiness, and head-to-head who is placed higher by most judges.</li>
      <li>Two guardrails balance consensus and genuine standouts:
        <ul>
          <li><b>Consensus guardrail</b>: if a band appears in the top 6 for at least three judges, they outrank bands that are not in the top 6 for at least two judges.</li>
          <li><b>Passion guardrail</b>: if a band is ranked 1st or 2nd by at least three judges, they are guaranteed a top-6 place.</li>
        </ul>
      </li>
      <li>We still display the <b>Avg Readiness</b> column for transparency. The official ordering uses the rank-based method above.</li>
    </ul>
  </section>
</main>

<script>
const WEIGHTS = { m:0.40, o:0.25, q:0.20, p:0.15 };

const elGate  = document.getElementById('gate');
const elPwd   = document.getElementById('adminPwd');
const elLoad  = document.getElementById('btnLoad');
const elCsv   = document.getElementById('btnCsv');
const elCsvWrap = document.getElementById('csvWrap');
const elStat  = document.getElementById('status');

const elCard  = document.getElementById('resultsCard');
const elBody  = document.getElementById('tbody');
const elSum   = document.getElementById('summary');

const elJudgesCard = document.getElementById('judgesCard');
const elJudgesBody = document.getElementById('tbodyJudges');
const elJudgeCount = document.getElementById('judgeCount');

const elExplain = document.getElementById('explainCard');

function readiness(s){ return s.m*WEIGHTS.m + s.o*WEIGHTS.o + s.q*WEIGHTS.q + s.p*WEIGHTS.p; }
function avg(a){ return a.length ? a.reduce((x,y)=>x+y,0)/a.length : 0; }
function to2(n){ return Number(n).toFixed(2); }
function byNum(a,b){ return a-b; }

function perJudgeRanking(scoresByBand){
  const entries = Object.entries(scoresByBand).map(([band,s])=>({band, r:readiness(s)}));
  entries.sort((a,b)=>b.r-a.r);
  const out = {};
  entries.forEach((e,i)=> out[e.band] = i+1);
  return out;
}

function combine(judgesObj){
  const perJudge = {};
  for (const [judge, sheet] of Object.entries(judgesObj||{})) {
    perJudge[judge] = perJudgeRanking(sheet.scores||{});
  }

  const bands = new Set();
  Object.values(judgesObj||{}).forEach(s=>{
    Object.keys(s.scores||{}).forEach(b=>bands.add(b));
  });

  const rows = [];
  for (const band of bands) {
    const ranks = [];
    const Ms=[], Os=[], Qs=[], Ps=[], Rs=[];
    for (const sheet of Object.values(judgesObj)) {
      const s = sheet.scores?.[band];
      if (!s) continue;
      ranks.push(perJudge[sheet.judge][band]);
      Ms.push(s.m); Os.push(s.o); Qs.push(s.q); Ps.push(s.p); Rs.push(readiness(s));
    }
    const medianRank = ranks.length ? ranks.sort(byNum)[Math.floor((ranks.length-1)/2)] : 0;
    const avgRank    = avg(ranks);
    rows.push({
      band,
      medianRank, avgRank,
      m:avg(Ms), o:avg(Os), q:avg(Qs), p:avg(Ps),
      readiness: avg(Rs),
      judges: ranks.length
    });
  }

  rows.sort((a,b)=>{
    if (a.medianRank !== b.medianRank) return a.medianRank - b.medianRank;
    if (a.avgRank !== b.avgRank) return a.avgRank - b.avgRank;
    if (a.readiness !== b.readiness) return b.readiness - a.readiness;
    return a.band.localeCompare(b.band);
  });

  return rows;
}

function renderJudges(entries){
  elJudgeCount.textContent = `Loaded ${entries.length} submission(s).`;
  elJudgesBody.innerHTML = entries.map(e=>{
    const d = e.ts ? new Date(e.ts).toLocaleString() : '';
    const bands = Object.keys(e.scores||{}).length;
    return `<tr>
      <td>${e.judge||e.judgekey}</td>
      <td>${d}</td>
      <td>${bands} bands scored</td>
      <td><button data-del="${e.judgekey}">Delete</button></td>
    </tr>`;
  }).join('');
  elJudgesBody.querySelectorAll('button[data-del]').forEach(btn=>{
    btn.onclick = async ()=>{
      if (!confirm('Delete this judge submission?')) return;
      const judgekey = btn.getAttribute('data-del');
      const pwd = elPwd.value.trim();
      const r = await fetch('/api/delete-score', {
        method:'POST',
        headers:{'content-type':'application/json'},
        body: JSON.stringify({ password: pwd, judgekey })
      });
      const t = await r.text();
      if (!r.ok) { try{ alert(JSON.parse(t).error) }catch{ alert('Delete failed') } ; return; }
      loadResults();
    };
  });
}

function renderResults(judgesObj){
  const rows = combine(judgesObj);

  elBody.innerHTML = rows.map((r,idx)=>`
    <tr>
      <td>${idx+1}. ${r.band}</td>
      <td class="right">${to2(r.medianRank)}</td>
      <td class="right">${to2(r.avgRank)}</td>
      <td class="right">${to2(r.m)}</td>
      <td class="right">${to2(r.o)}</td>
      <td class="right">${to2(r.q)}</td>
      <td class="right">${to2(r.p)}</td>
      <td class="right readiness">${to2(r.readiness)}</td>
      <td class="right">${r.judges}</td>
    </tr>
  `).join('');

  elSum.textContent = rows.length
    ? `Top 6 by final ordering: ${rows.slice(0,6).map(r=>r.band).join(', ')}.`
    : 'No scores found yet.';

  elCard.classList.remove('hidden');
}

function downloadCsv(judgesObj){
  const lines = [];
  lines.push(['judge','band','musicianship','originality','material_quality','online_presence','readiness'].join(','));
  for (const [judge, sheet] of Object.entries(judgesObj||{})) {
    const scores = sheet?.scores || {};
    for (const [band, v] of Object.entries(scores)) {
      const r = readiness(v);
      lines.push([
        `"${judge.replace(/"/g,'""')}"`,
        `"${band.replace(/"/g,'""')}"`,
        to2(v.m||0), to2(v.o||0), to2(v.q||0), to2(v.p||0), to2(r)
      ].join(','));
    }
  }
  const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='wmb-results.csv'; a.click();
  URL.revokeObjectURL(url);
}

async function loadResults(){
  elCsvWrap.classList.add('hidden');
  elCard.classList.add('hidden');
  elJudgesCard.classList.add('hidden');
  elExplain.classList.add('hidden');
  elStat.textContent = 'Loading…';

  const pwd = elPwd.value.trim();
  const res = await fetch('/api/get-scores?__=' + Date.now(), {
    method:'POST',
    headers:{'content-type':'application/json'},
    body: JSON.stringify({ password: pwd })
  });

  const text = await res.text();
  if (!res.ok) {
    let msg = 'Auth failed or server error.';
    try { msg = JSON.parse(text).error || msg; } catch {}
    alert(msg);
    elStat.textContent = '';
    return;
  }

  let data = {};
  try { data = JSON.parse(text); } catch {}

  // Success: hide gate and show the rest of the page
  elGate.classList.add('hidden');
  elStat.textContent = '';

  const judges = data.judges || {};
  const entries = data.entries || {};

  renderResults(judges);
  renderJudges(entries);

  elCsvWrap.classList.remove('hidden');
  elCsv.onclick = () => downloadCsv(judges);
  elJudgesCard.classList.remove('hidden');
  elExplain.classList.remove('hidden');
}

elLoad.addEventListener('click', loadResults);
</script>
</body>
</html>
