<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Live Results — Wacken Metal Battle Cyprus</title>
<style>
  :root{
    --bg:#0a0a0b; --panel:#151215; --text:#f2f2f2; --muted:#b8b6bb; --crimson:#b3121f;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    background:#0a0a0b;
    color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
  }
  header{
    position:sticky;top:0;z-index:50;
    background:linear-gradient(180deg,rgba(10,10,11,.9),rgba(10,10,11,.8));
    border-bottom:1px solid #231a1d;
    backdrop-filter:blur(8px);
  }
  .container{max-width:1140px;margin:0 auto;padding:16px 20px}
  .nav{display:flex;align-items:center;gap:16px}
  .site-title{font-size:clamp(22px,4vw,32px);font-weight:800;letter-spacing:.3px}
  .logo{width:84px;height:auto;filter:drop-shadow(0 8px 18px rgba(0,0,0,.6))}
  .nav-btn{
    display:inline-flex;align-items:center;gap:8px;
    background:#8f1220;color:#fff;border:1px solid #6b0c12;
    padding:8px 14px;border-radius:12px;font-size:14px;text-decoration:none;
  }
  .nav-btn:hover{filter:brightness(1.05)}
  .card{background:linear-gradient(180deg,#181316,#110f10);border:1px solid #2b2023;border-radius:14px;padding:16px;margin:18px 0}
  .meta{color:var(--muted);font-size:13px}
  .right{text-align:right}
  .hidden{display:none}
  .boldwhite{font-weight:800;color:#fff;font-size:18px}
  input,button{font:inherit}
  input[type=password]{background:#120f10;border:1px solid #2b2023;border-radius:10px;color:var(--text);padding:8px 10px;min-width:240px}
  button{background:#1a1416;border:1px solid #2b2023;color:#ffefe9;border-radius:10px;padding:8px 12px;cursor:pointer}
  button.primary{background:#b3121f;border-color:#b3121f}
  button.danger{background:#7a2626;border-color:#7a2626}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px 12px;border-bottom:1px solid #2b2023}
  thead th{font-size:13px;text-transform:uppercase;letter-spacing:.35px;color:#ffefe9;background:linear-gradient(180deg,rgba(179,18,31,.22),rgba(139,15,23,.08))}
</style>
</head>
<body>
<header>
  <div class="container nav">
    <img class="logo" src="/public/wmb-logo.png?v=2" alt="Wacken Metal Battle Cyprus logo">
    <div class="site-title">Live Results — Wacken Metal Battle Cyprus</div>
    <nav style="margin-left:auto;display:flex;gap:10px;flex-wrap:wrap">
      <a href="/judge.html" class="nav-btn">Online round form</a>
      <a href="/results.html" class="nav-btn">Online results</a>
      <a href="/live-judge.html" class="nav-btn">Live judge form</a>
      <a href="/live.html" class="nav-btn">Live scoreboard</a>
    </nav>
  </div>

  <div class="container" style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
    <div class="meta">Last updated <span id="lastUpdated">–</span></div>
    <div style="margin-left:auto;display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <input id="adminPwd" type="password" placeholder="Admin / results password" autocomplete="current-password">
      <button id="btnLoad" class="primary">Refresh now</button>
      <button id="btnClear" class="danger">Clear live scores</button>
      <span id="status" class="meta"></span>
    </div>
  </div>
</header>

<main class="container">
  <section id="resultsCard" class="card hidden">
    <div id="summary" class="boldwhite" style="margin-bottom:10px"></div>
    <div style="overflow:auto">
      <table aria-label="Live results table">
        <thead>
          <tr>
            <th>Band</th>
            <th class="right">Avg Tightness</th>
            <th class="right">Avg Songwriting</th>
            <th class="right">Avg Stage presence</th>
            <th class="right">Avg Crowd engagement</th>
            <th class="right">Avg live readiness</th>
            <th class="right">Judges</th>
          </tr>
        </thead>
        <tbody id="tbodyLive"></tbody>
      </table>
    </div>
  </section>

  <section id="judgesCard" class="card hidden">
    <div style="font-weight:700;margin:0 0 8px">Live judge submissions</div>
    <div class="meta" id="judgeCount"></div>
    <div style="overflow:auto;margin-top:8px">
      <table aria-label="Judge submissions">
        <thead>
          <tr><th>Judge</th><th>Date</th><th>Details</th><th>Actions</th></tr>
        </thead>
        <tbody id="tbodyJudges"></tbody>
      </table>
    </div>
  </section>
</main>

<script>
  const FINALISTS = ['Blynd','Guiltera','Speak In Whispers',"Ka'aper",'Salienzor','YMNKY!'];
  const WEIGHTS = { tight: 0.30, song: 0.25, stage: 0.25, crowd: 0.20 };

  const elPwd   = document.getElementById('adminPwd');
  const elLoad  = document.getElementById('btnLoad');
  const elClear = document.getElementById('btnClear');
  const elStat  = document.getElementById('status');
  const elLast  = document.getElementById('lastUpdated');

  const elCard  = document.getElementById('resultsCard');
  const elBody  = document.getElementById('tbodyLive');

  const elJudgesCard = document.getElementById('judgesCard');
  const elJudgesBody = document.getElementById('tbodyJudges');
  const elJudgeCount = document.getElementById('judgeCount');

  function isLiveKey(k){
    return /^wmb:(live|livescore|live_draft|live-score|live_scores|liveScore):/.test(String(k||''));
  }

  function liveReadiness(s){
    const t = Number(s.tight || 0);
    const so = Number(s.song || 0);
    const st = Number(s.stage || 0);
    const c = Number(s.crowd || 0);
    return t*WEIGHTS.tight + so*WEIGHTS.song + st*WEIGHTS.stage + c*WEIGHTS.crowd;
  }
  const to2 = n => Number(n||0).toFixed(2);

  function escapeHtml(s){
    return String(s || '')
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  }

  function combineLiveResults(entries){
    const rows = [];

    FINALISTS.forEach(band => {
      const tightArr=[], songArr=[], stageArr=[], crowdArr=[], readyArr=[];
      let judgesCount = 0;

      for (const entry of entries || []) {
        const s = entry.scores?.[band];
        if (!s) continue;
        judgesCount++;
        tightArr.push(Number(s.tight || 0));
        songArr.push(Number(s.song || 0));
        stageArr.push(Number(s.stage || 0));
        crowdArr.push(Number(s.crowd || 0));
        readyArr.push(liveReadiness(s));
      }

      const avg = a => a.length ? a.reduce((x,y)=>x+y,0)/a.length : 0;

      rows.push({
        band,
        tight: avg(tightArr),
        song: avg(songArr),
        stage: avg(stageArr),
        crowd: avg(crowdArr),
        readiness: avg(readyArr),
        judges: judgesCount
      });
    });

    rows.sort((a,b)=>{
      if (a.readiness !== b.readiness) return b.readiness - a.readiness;
      return a.band.localeCompare(b.band);
    });

    return rows;
  }

  function renderLiveTable(entries){
    const rows = combineLiveResults(entries);

    elBody.innerHTML = rows.map((r,idx)=>`
      <tr>
        <td>${idx+1}. ${escapeHtml(r.band)}</td>
        <td class="right">${to2(r.tight)}</td>
        <td class="right">${to2(r.song)}</td>
        <td class="right">${to2(r.stage)}</td>
        <td class="right">${to2(r.crowd)}</td>
        <td class="right"><b>${to2(r.readiness)}</b></td>
        <td class="right">${r.judges}</td>
      </tr>
    `).join('');

    document.getElementById('summary').textContent =
      rows.length ? `Top 6 by live scores: ${rows.map(r=>r.band).join(', ')}.` : 'No live scores submitted yet.';

    elCard.classList.remove('hidden');
  }

  function makePrintableHtml(judgeName, scores){
    const rows = FINALISTS.map(name => {
      const s = scores[name] || {};
      return {
        name,
        tight: s.tight|0,
        song:  s.song|0,
        stage: s.stage|0,
        crowd: s.crowd|0,
        r: to2(liveReadiness(s)),
        note: (s.note||'').trim(),
      };
    }).sort((a,b)=>Number(b.r)-Number(a.r));

    const lines = rows.map(r => `
      <tr>
        <td>${escapeHtml(r.name)}</td>
        <td>${r.tight}</td>
        <td>${r.song}</td>
        <td>${r.stage}</td>
        <td>${r.crowd}</td>
        <td><b>${r.r}</b></td>
        <td>${escapeHtml(r.note)}</td>
      </tr>
    `).join('');

    return `
<!doctype html><html><head><meta charset="utf-8">
<title>Live scoring — ${escapeHtml(judgeName || '')}</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;padding:20px;color:#111}
  h1{margin:0 0 6px}
  .muted{color:#555}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid #ccc;padding:6px 8px;text-align:left}
  thead th{background:#f3f3f3}
</style></head><body>
<h1>Wacken Metal Battle Cyprus — Live scoring</h1>
<div class="muted">Judge: ${escapeHtml(judgeName || '')}</div>
<table>
  <thead>
    <tr>
      <th>Band</th>
      <th>Tightness</th>
      <th>Songwriting</th>
      <th>Stage presence</th>
      <th>Crowd engagement</th>
      <th>Live readiness</th>
      <th>Notes</th>
    </tr>
  </thead>
  <tbody>${lines}</tbody>
</table>
<script>window.addEventListener('load',()=>{window.print();});<\/script>
</body></html>`;
  }

  function renderJudges(entries){
    elJudgeCount.textContent = `Loaded ${entries.length} live submission(s).`;

    elJudgesBody.innerHTML = entries.map(e=>{
      const d = e.ts ? new Date(e.ts).toLocaleString() : '';
      const bands = Object.keys(e.scores||{}).length;
      const key = String(e.key || '');

      const canDelete = isLiveKey(key);

      return `<tr>
        <td>${escapeHtml(e.judge || e.judgekey || '')}</td>
        <td>${escapeHtml(d)}</td>
        <td>${bands} bands scored</td>
        <td>
          <button data-view="${escapeHtml(key)}">View card</button>
          ${canDelete ? `<button data-del="${escapeHtml(key)}" class="danger">Delete</button>` : `<span class="meta">Not live</span>`}
        </td>
      </tr>`;
    }).join('');

    elJudgesBody.querySelectorAll('button[data-view]').forEach(btn=>{
      btn.onclick = ()=>{
        const key = btn.getAttribute('data-view');
        const entry = entries.find(e => String(e.key||'') === String(key||''));
        if (!entry) { alert('Could not find this judge submission.'); return; }
        const html = makePrintableHtml(entry.judge || entry.judgekey || '', entry.scores || {});
        const blob = new Blob([html], {type:'text/html;charset=utf-8'});
        const url = URL.createObjectURL(blob);
        window.open(url, '_blank');
      };
    });

    elJudgesBody.querySelectorAll('button[data-del]').forEach(btn=>{
      btn.onclick = async ()=>{
        if (!confirm('Delete this live judge submission?')) return;
        const key = btn.getAttribute('data-del');
        const pwd = elPwd.value.trim();

        const r = await fetch('/api/delete-live-score', {
          method:'POST',
          headers:{'content-type':'application/json'},
          body: JSON.stringify({ password: pwd, key })
        });

        const t = await r.text();
        if (!r.ok) {
          try{ alert(JSON.parse(t).error); }catch{ alert('Delete failed'); }
          return;
        }
        loadLiveResults();
      };
    });

    elJudgesCard.classList.remove('hidden');
  }

  async function loadLiveResults(){
    elStat.textContent = 'Loading…';
    elCard.classList.add('hidden');
    elJudgesCard.classList.add('hidden');

    const pwd = elPwd.value.trim();
    const res = await fetch('/api/get-live-scores?__=' + Date.now(), {
      method:'POST',
      headers:{'content-type':'application/json'},
      body: JSON.stringify({ password: pwd })
    });

    const text = await res.text();
    if (!res.ok) {
      let msg = 'Auth failed or server error.';
      try { msg = JSON.parse(text).error || msg; } catch {}
      alert(msg);
      elStat.textContent = '';
      return;
    }

    let data = {};
    try { data = JSON.parse(text); } catch {}
    const entries = Array.isArray(data.entries) ? data.entries : [];

    renderLiveTable(entries);
    renderJudges(entries);

    elStat.textContent = '';
    elLast.textContent = new Date().toLocaleTimeString();
  }

  elLoad.addEventListener('click', loadLiveResults);

  elClear.addEventListener('click', async ()=>{
    const pwd = elPwd.value.trim();
    if (!pwd) { alert('Enter admin password first.'); return; }
    if (!confirm('Clear ALL live scores and drafts? This does not touch online results.')) return;

    const r = await fetch('/api/clear-live-scores', {
      method:'POST',
      headers:{'content-type':'application/json'},
      body: JSON.stringify({ password: pwd })
    });
    const t = await r.text();
    if (!r.ok) {
      try { alert(JSON.parse(t).error || 'Clear failed'); } catch { alert('Clear failed'); }
      return;
    }
    loadLiveResults();
  });
</script>
</body>
</html>
