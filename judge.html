<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Judging Panel — Wacken Metal Battle Cyprus</title>
<style>
  :root{
    --bg:#0a0a0b; --panel:#151215; --text:#f2f2f2; --muted:#b8b6bb;
    --line:#2b2023; --ring:rgba(255,90,31,.35);
    --ok:#2a6b3a; --ok-900:#173e22;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0d0b0d,#080708 65%);color:var(--text);
       font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
  .container{max-width:900px;margin:0 auto;padding:20px}
  .card{background:linear-gradient(180deg,#181316,#110f10);border:1px solid var(--line);
        border-radius:16px;padding:16px;box-shadow:0 18px 40px rgba(0,0,0,.45)}
  .h1{font-size:clamp(20px,2.6vw,30px);font-weight:800;margin:0 0 8px}
  .muted{color:var(--muted)}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;
        background:#1a1416;border:1px solid var(--line);color:#ccc;font-size:12px}
  a{color:#ffd7c3;text-decoration:none}

  input[type=text],input[type=password]{background:#0f0d0e;border:1px solid var(--line);
    color:var(--text);padding:10px 12px;border-radius:10px;min-width:220px}
  button{background:#1a1416;border:1px solid var(--line);color:#fff;padding:10px 14px;border-radius:12px;cursor:pointer}
  button.primary{background:var(--ok);border-color:var(--ok)}
  button.warn{background:#7a2626;border-color:#7a2626}
  button:focus,input:focus,textarea:focus{outline:2px solid var(--ring);outline-offset:2px}

  .login{display:grid;gap:12px;max-width:560px;margin:28px auto}
  .login h2{margin:0}
  .hidden{display:none}

  .explainer{display:grid;gap:10px;margin:12px 0}
  .ex-row{display:grid;gap:6px;border:1px solid var(--line);border-radius:12px;padding:12px;background:#130f10}
  .ex-row b{font-weight:700}

  .band{border:1px solid var(--line);border-radius:14px;padding:14px;background:#120f10;margin-bottom:14px}
  .band h3{margin:0 0 4px;font-size:18px}
  .band .meta{color:var(--muted);font-size:13px;margin-bottom:8px}
  iframe{border:none;border-radius:12px;min-height:176px;background:#000;width:100%;margin:6px 0 10px}

  .row{display:grid;gap:8px;margin:10px 0}
  .row label{font-size:14px;font-weight:600}
  .control{display:flex;gap:10px;align-items:center}
  .control input[type=range]{width:100%}
  .badge{background:#1a1416;border:1px solid var(--line);border-radius:10px;padding:6px 10px;min-width:48px;text-align:center}

  .readiness{display:flex;justify-content:space-between;align-items:center;margin-top:8px;
             border-top:1px solid var(--line);padding-top:10px}
  .readiness b{font-size:16px}

  textarea{width:100%;min-height:70px;resize:vertical;background:#0f0d0e;border:1px solid var(--line);
           color:#fff;border-radius:10px;padding:10px}

  .topbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:0 0 16px}
  .right{margin-left:auto}

  /* Success notice */
  .notice{display:none;margin-top:12px;padding:12px;border-radius:12px;border:1px solid var(--ok);
          background:linear-gradient(180deg,var(--ok-900),#112315);color:#e6ffec}
  .notice.show{display:block}

  /* Back warning modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:1000}
  .modal{background:#141114;border:1px solid var(--line);border-radius:14px;max-width:520px;width:92%;padding:16px}
  .modal h3{margin:0 0 8px}
  .modal p{margin:0 0 12px;color:var(--muted)}
  .modal .actions{display:flex;gap:10px;justify-content:flex-end}
  .modal-backdrop.show{display:flex}
</style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <h1 class="h1" style="margin:0">Judging Panel — Wacken Metal Battle Cyprus</h1>
      <div class="right">
        <a class="pill" href="/" target="_blank" rel="noopener">Open home in new tab</a>
      </div>
    </div>

    <!-- Password gate -->
    <section id="gate" class="card login">
      <h2>Enter judging password</h2>
      <p class="muted">Your scores autosave in this browser until you submit. If you close this page before submitting, they’ll still be here when you return and unlock again.</p>
      <input id="judgeName" type="text" placeholder="Your name e.g. Maria K." autocomplete="name">
      <input id="judgePwd" type="password" placeholder="Judge password" autocomplete="current-password">
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <button id="btnLogin" class="primary">Unlock scoring</button>
        <!-- Refresh button is intentionally hidden on the gate per your request -->
        <span id="gateMsg" class="muted"></span>
      </div>
    </section>

    <!-- Panel -->
    <section id="panel" class="hidden">
      <div class="topbar">
        <span class="pill">Autosaves locally until you submit</span>
        <input id="judgeNameTop" type="text" placeholder="Judge name" />
      </div>

      <div class="card">
        <div class="explainer">
          <div class="ex-row"><b>Musicianship 40 percent</b>
            <div>Technical skill, timing, tightness, vocal control, compositional ability.</div></div>
          <div class="ex-row"><b>Originality 25 percent</b>
            <div>Distinctive sound or concept, songwriting ideas, creativity, not derivative.</div></div>
          <div class="ex-row"><b>Online Material Quality 20 percent</b>
            <div>Quality of videos and recordings, presentation, professionalism of artwork or photos.</div></div>
          <div class="ex-row"><b>Online Presence 15 percent</b>
            <div>Engagement and following across platforms, posting consistency, communication with fans.</div></div>
        </div>
        <p class="muted">Score each band from 0 to 10. Wacken Readiness is a weighted score:
          40 percent Musicianship, 25 percent Originality, 20 percent Online Material Quality, 15 percent Online Presence.</p>
      </div>

      <div id="bandsWrap" class="card" style="margin-top:14px"></div>

      <!-- Bottom controls -->
      <div class="card" style="margin-top:14px">
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
          <button id="btnNew" class="warn">Refresh your scores & start again</button>
          <button id="btnSubmit" class="primary">Submit your Scores</button>
        </div>
        <div id="submitNotice" class="notice">Thank you — scores submitted.</div>
      </div>
    </section>
  </div>

  <!-- Back modal -->
  <div id="backModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="backTitle">
      <h3 id="backTitle">Leaving this page</h3>
      <p>To not lose your current scores, <a href="/" target="_blank" rel="noopener">click here to open the home page in a new tab</a>. You can then return here and continue scoring.</p>
      <div class="actions">
        <button id="stayHere">Stay here</button>
        <a href="/" target="_self" class="primary" id="goHome">Go to home</a>
      </div>
    </div>
  </div>

<script>
  // Local persistence (Option B)
  const L_SCORES='wmb.judge.scores.local';
  const L_NAME='wmb.judge.name.local';

  // Password is session-only
  const S_PWD='wmb.judge.pwd.s';

  const gate=document.getElementById('gate');
  const panel=document.getElementById('panel');
  const nameField=document.getElementById('judgeName');
  const nameTop=document.getElementById('judgeNameTop');
  const pwdField=document.getElementById('judgePwd');
  const msg=document.getElementById('gateMsg');

  // Load any saved judge name on the gate
  try{ nameField.value = localStorage.getItem(L_NAME) || ''; }catch{}

  async function loadBandsScript(){
    await new Promise((resolve)=>{
      const s=document.createElement('script');
      s.src='/bands.js?v=judge-embed-fallback1';
      s.onload=resolve; s.onerror=resolve;
      document.head.appendChild(s);
    });
    return Array.isArray(window.BANDS)?window.BANDS:[];
  }

  async function checkPassword(pwd){
    try{
      const r=await fetch('/api/judge-check',{
        method:'POST',headers:{'content-type':'application/json'},
        body:JSON.stringify({password:pwd})
      });
      return r.ok;
    }catch{return false;}
  }

  function openPanel(){
    gate.classList.add('hidden');
    panel.classList.remove('hidden');
    // load judge name into the top field and keep it in localStorage
    const existingName = (nameField.value || localStorage.getItem(L_NAME) || '').trim();
    nameTop.value = existingName;
    nameTop.addEventListener('input',()=>{ try{ localStorage.setItem(L_NAME,nameTop.value); }catch{} });
    try{ localStorage.setItem(L_NAME, existingName); }catch{}
    initHistoryTrap();
  }

  document.getElementById('btnLogin').addEventListener('click',async()=>{
    msg.textContent='Checking...';
    const pwd = pwdField.value.trim();
    const ok=await checkPassword(pwd);
    if(!ok){ msg.textContent='Wrong password'; return; }
    sessionStorage.setItem(S_PWD,pwd);
    msg.textContent='Unlocked';
    openPanel();
    initScoring();
  });

  function clearAllLocal(){
    try{
      localStorage.removeItem(L_SCORES);
      localStorage.removeItem(L_NAME);
    }catch{}
    sessionStorage.removeItem(S_PWD);
  }
  function clearAndReload(){
    clearAllLocal();
    location.replace(location.pathname + '?new=1');
  }
  document.getElementById('btnNew').onclick = clearAndReload;

  const WEIGHTS={m:0.40,o:0.25,q:0.20,p:0.15};
  function weighted(m,o,q,p){ return (m*WEIGHTS.m + o*WEIGHTS.o + q*WEIGHTS.q + p*WEIGHTS.p).toFixed(2); }
  function getSaved(){ try{return JSON.parse(localStorage.getItem(L_SCORES)||'{}')}catch{return{}} }
  function saveLocal(d){ try{ localStorage.setItem(L_SCORES,JSON.stringify(d)); }catch{} }

  function ytId(url){
    if(!url) return null;
    try{
      const u=new URL(url.replace("music.youtube.com","www.youtube.com"));
      const id=u.searchParams.get('v');
      if(id) return id;
      const parts=u.pathname.split('/').filter(Boolean);
      const i=parts.indexOf('shorts');
      if(i!==-1 && parts[i+1]) return parts[i+1];
    }catch(e){}
    return null;
  }
  function spotifyEmbed(url){
    if(!url) return null;
    try{
      const u=new URL(url.replace("?si","/ignore?si"));
      const parts=u.pathname.split('/').filter(Boolean);
      const type=parts[0], id=parts[1];
      if(type==='track' && id) return `https://open.spotify.com/embed/track/${id}`;
      if(type==='artist' && id) return `https://open.spotify.com/embed/artist/${id}`;
      if(type==='album' && id) return `https://open.spotify.com/embed/album/${id}`;
    }catch(e){}
    return null;
  }

  function embedBlock(band){
    const vidId = ytId(band.youtube);
    if(vidId){
      return `<iframe allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen src="https://www.youtube-nocookie.com/embed/${vidId}"></iframe>`;
    }
    const sp = spotifyEmbed(band.spotify);
    return sp ? `<iframe allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy" src="${sp}"></iframe>` : '';
  }

  function bandCard(band, saved){
    const s=saved[band.name]||{m:0,o:0,q:0,p:0,c:''};
    const ready=weighted(s.m,s.o,s.q,s.p);
    const media = embedBlock(band);

    return `
      <article class="band" data-band="${band.name}">
        <h3>${band.name}</h3>
        <div class="meta">${band.city||''}${band.city&&band.genre?' · ':''}${band.genre||''}</div>

        ${media}

        <div class="row">
          <label>Musicianship</label>
          <div class="control">
            <input type="range" min="0" max="10" step="1" value="${s.m}" data-k="m">
            <span class="badge" data-kv="m">${s.m}</span>
          </div>
        </div>

        <div class="row">
          <label>Originality</label>
          <div class="control">
            <input type="range" min="0" max="10" step="1" value="${s.o}" data-k="o">
            <span class="badge" data-kv="o">${s.o}</span>
          </div>
        </div>

        <div class="row">
          <label>Online Material Quality</label>
          <div class="control">
            <input type="range" min="0" max="10" step="1" value="${s.q}" data-k="q">
            <span class="badge" data-kv="q">${s.q}</span>
          </div>
        </div>

        <div class="row">
          <label>Online Presence</label>
          <div class="control">
            <input type="range" min="0" max="10" step="1" value="${s.p}" data-k="p">
            <span class="badge" data-kv="p">${s.p}</span>
          </div>
        </div>

        <div class="readiness">
          <span class="muted">Wacken Readiness</span>
          <b data-ready>${ready}</b>
        </div>

        <div class="row">
          <label>Comments</label>
          <textarea data-k="c" placeholder="Optional comments">${s.c||''}</textarea>
        </div>
      </article>
    `;
  }

  async function initScoring(){
    const wrap=document.getElementById('bandsWrap');
    const saved=getSaved();
    const bands=(await loadBandsScript()).slice().sort((a,b)=>a.name.localeCompare(b.name));
    wrap.innerHTML = bands.map(b=>bandCard(b,saved)).join('');

    wrap.querySelectorAll('.band').forEach(card=>{
      const name=card.getAttribute('data-band');
      const set=saved[name]||(saved[name]={m:0,o:0,q:0,p:0,c:''});
      card.querySelectorAll('input[type=range]').forEach(sl=>{
        sl.addEventListener('input',()=>{
          const k=sl.getAttribute('data-k');
          set[k]=Number(sl.value);
          card.querySelector(`[data-kv="${k}"]`).textContent=set[k];
          card.querySelector('[data-ready]').textContent=weighted(set.m,set.o,set.q,set.p);
          saveLocal(saved);
        });
      });
      const ta=card.querySelector('textarea');
      ta.addEventListener('input',()=>{ set.c=ta.value; saveLocal(saved); });
    });

    // bottom submit
    document.getElementById('btnSubmit').onclick=async()=>{
      const gateName = (nameField.value||'').trim();
      const topName  = (nameTop.value||'').trim();
      const judge = topName || gateName;
      if(!judge){ alert('Please enter your name at the top.'); return; }
      const pwd = sessionStorage.getItem(S_PWD)||'';
      if(!pwd){ alert('Your session expired. Click “Refresh your scores & start again” and unlock again.'); return; }

      // Persist the latest judge name
      try{ localStorage.setItem(L_NAME, judge); }catch{}

      const payload={ judge, password: pwd, scores: getSaved() };
      const r = await fetch('/api/submit-score', {
        method:'POST',
        headers:{'content-type':'application/json'},
        body: JSON.stringify(payload)
      });

      const notice = document.getElementById('submitNotice');
      if(r.ok){
        notice.textContent = 'Thank you — scores submitted.';
        notice.classList.add('show');
        setTimeout(()=>{ window.location.href = '/'; }, 1200);
      }else{
        notice.textContent = 'Could not save. Check password or connection.';
        notice.classList.add('show');
        setTimeout(()=>notice.classList.remove('show'), 4000);
      }
    };
  }

  // History back-button trap with custom modal
  function initHistoryTrap(){
    // push a state when panel opens so back triggers popstate
    try{ history.pushState({wmb:'judge'}, '', location.href); }catch{}
    const modal = document.getElementById('backModal');
    const stay = document.getElementById('stayHere');

    function showModal(){
      modal.classList.add('show');
      modal.setAttribute('aria-hidden','false');
    }
    function hideModal(){
      modal.classList.remove('show');
      modal.setAttribute('aria-hidden','true');
    }

    window.addEventListener('popstate', (ev)=>{
      // immediately push state back to neutralize navigation
      try{ history.pushState({wmb:'judge'}, '', location.href); }catch{}
      // only show modal if we have any scores saved
      const saved = getSaved();
      if (saved && Object.keys(saved).length>0) {
        showModal();
      } else {
        // if nothing saved, allow navigation to home
        window.location.href = '/';
      }
    });

    stay.addEventListener('click', hideModal);
    // The "Go to home" link is a normal anchor in the modal actions
  }
</script>
</body>
</html>
