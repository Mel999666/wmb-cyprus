<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Judging Panel — Wacken Metal Battle Cyprus</title>
<style>
  :root{
    --bg:#0a0a0b; --panel:#151215; --text:#f2f2f2; --muted:#b8b6bb;
    --line:#2b2023; --ring:rgba(255,90,31,.35);
    /* Maroon palette in use on main site */
    --maroon-1:#a01624; --maroon-2:#8f1220; --maroon-border:#6b0c12;
    --link-orange:#ff5a1f;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    background:linear-gradient(180deg,#0d0b0d,#080708 65%);
    color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif
  }
  .container{max-width:900px;margin:0 auto;padding:20px}

  /* Default cards */
  .card{
    background:linear-gradient(180deg,#181316,#110f10);
    border:1px solid var(--line);
    border-radius:16px;
    padding:16px;
    box-shadow:0 18px 40px rgba(0,0,0,.45)
  }

  /* Password gate card: maroon gradient */
  #gate.card{
    background:linear-gradient(180deg,var(--maroon-1),var(--maroon-2) 85%);
    border-color:var(--maroon-border);
  }
  /* Inputs on the maroon gate: slightly lighter border for contrast */
  #gate input[type=text], #gate input[type=password]{ border-color:#7e1a21 }

  .h1{font-size:clamp(20px,2.6vw,30px);font-weight:800;margin:0 0 8px}
  .muted{color:var(--muted)}
  .pill{
    display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;
    background:#1a1416;border:1px solid var(--line);color:#ccc;font-size:12px
  }
  a{color:#ffd7c3;text-decoration:none}

  input[type=text],input[type=password]{
    background:#0f0d0e;border:1px solid var(--line);
    color:var(--text);padding:10px 12px;border-radius:10px;min-width:220px
  }
  button{background:#2a6b3a;border:none;color:#fff;padding:10px 14px;border-radius:12px;cursor:pointer}
  button.secondary{background:#1a1416;border:1px solid var(--line);color:#fff}
  button.warn{background:#7a2626}
  button:focus,input:focus,textarea:focus{outline:2px solid var(--ring);outline-offset:2px}

  .login{display:grid;gap:12px;max-width:560px;margin:28px auto}
  .login h2{margin:0}

  .hidden{display:none}

  /* Criteria explainer boxes now use maroon background like main-page headings */
  .explainer{display:grid;gap:10px;margin:16px 0}
  .ex-row{
    display:grid;gap:6px;
    border:1px solid var(--maroon-border);
    border-radius:12px;
    padding:12px;
    background:linear-gradient(180deg, rgba(160,22,36,0.20), rgba(143,18,32,0.10));
  }
  .ex-row b{font-weight:700}

  /* Instruction line shown only after login, under the main title */
  #weighingNote{
    margin:6px 0 14px;
    font-style:italic;
    font-weight:700;
  }

  /* Band scoring card: keep layout, but add a band-head with maroon gradient like main page */
  .band{
    border:1px solid var(--line);
    border-radius:14px;
    background:#120f10;
    margin-bottom:14px;
    overflow:hidden;
  }
  .band .band-head{
    display:flex;justify-content:space-between;align-items:center;
    padding:12px 14px;
    background:linear-gradient(180deg, rgba(179,18,31,.18), transparent);
    /* If you prefer the stronger maroon header, swap the line above with:
       background:linear-gradient(180deg,var(--maroon-1),var(--maroon-2) 85%);
    */
    border-bottom:1px solid var(--line);
  }
  .band .band-name{font-size:18px;font-weight:800}
  .band .meta{color:var(--muted);font-size:13px}
  .band .links{display:flex;gap:12px;flex-wrap:wrap}
  .band .links a{font-size:13px;color:var(--link-orange)}

  .band .inner{padding:14px}
  .row{display:grid;gap:8px;margin:10px 0}
  .row label{font-size:14px;font-weight:600}
  .control{display:flex;gap:10px;align-items:center}
  .control input[type=range]{width:100%}
  .badge{background:#1a1416;border:1px solid var(--line);border-radius:10px;padding:6px 10px;min-width:48px;text-align:center}

  iframe{border:none;border-radius:12px;min-height:180px;background:#000;width:100%}

  .readiness{
    display:flex;justify-content:space-between;align-items:center;margin-top:8px;
    border-top:1px solid var(--line);padding-top:10px
  }
  .readiness b{font-size:16px}

  textarea{width:100%;min-height:70px;resize:vertical;background:#0f0d0e;border:1px solid var(--line);
           color:#fff;border-radius:10px;padding:10px}

  .bottom-actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end;margin-top:14px}

  /* Ranking table */
  #ranking.card{margin-top:14px}
  #rankTable{width:100%;border-collapse:collapse}
  #rankTable th,#rankTable td{padding:10px 12px;border-bottom:1px solid var(--line)}
  #rankTable thead th{
    font-size:13px;text-transform:uppercase;letter-spacing:.35px;color:#ffefe9;
    background:linear-gradient(180deg,rgba(179,18,31,.22),rgba(139,15,23,.08))
  }
  #rankTable td.right{text-align:right}

  /* Overlay for back-warning */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:9999}
  .overlay .box{background:#181316;border:1px solid var(--line);border-radius:14px;padding:16px;max-width:520px}
  .overlay .box h3{margin:0 0 8px}
</style>
</head>
<body>
  <div class="container">
    <h1 class="h1">Judging Panel — Wacken Metal Battle Cyprus</h1>
    <!-- Shown only after login -->
    <p id="weighingNote" class="hidden">
      Score each band from 0 to 10. Wacken Readiness is a weighted score: 40% Musicianship, 25% Originality, 20% Online Material Quality, 15% Online Presence.
    </p>

    <!-- Password gate (maroon) -->
    <section id="gate" class="card login">
      <h2>Enter judging password</h2>
      <input id="judgeName" type="text" placeholder="Your name e.g. Maria K." autocomplete="name">
      <input id="judgePwd" type="password" placeholder="Judge password" autocomplete="current-password">
      <div style="display:flex;gap:10px;align-items:center">
        <button id="btnLogin">Unlock scoring</button>
        <span id="gateMsg" class="muted"></span>
      </div>
    </section>

    <!-- Scoring panel -->
    <section id="panel" class="hidden">
      <div class="card">
        <div class="explainer">
          <div class="ex-row"><b>Musicianship 40%</b>
            <div>Technical skill, timing, tightness, vocal control, compositional ability.</div></div>
          <div class="ex-row"><b>Originality 25%</b>
            <div>Distinctive sound or concept, songwriting ideas, creativity, not derivative.</div></div>
          <div class="ex-row"><b>Online Material Quality 20%</b>
            <div>Quality of videos and recordings, presentation, professionalism of artwork or photos.</div></div>
          <div class="ex-row"><b>Online Presence 15%</b>
            <div>Engagement and following across platforms, posting consistency, communication with fans.</div></div>
        </div>
      </div>

      <div id="bandsWrap" class="card" style="margin-top:14px"></div>

      <!-- Live ranking table -->
      <section id="ranking" class="card hidden">
        <div style="font-weight:800;margin-bottom:8px">Your current ranking</div>
        <div style="overflow:auto">
          <table id="rankTable" aria-label="Ranking by Wacken Readiness">
            <thead>
              <tr><th>Band</th><th class="right">Wacken Readiness</th></tr>
            </thead>
            <tbody id="rankBody"></tbody>
          </table>
        </div>
      </section>

      <div class="card bottom-actions">
        <input id="judgeNameTop" type="text" placeholder="Judge name" />
        <button id="btnResetSliders" class="warn">Refresh your scores & start again</button>
        <button id="btnDownload" class="secondary">Download your completed scoring card</button>
        <button id="btnSave">Submit your Scores</button>
      </div>
    </section>
  </div>

  <!-- back warning overlay -->
  <div id="backOverlay" class="overlay">
    <div class="box">
      <h3>Leaving the scoring page</h3>
      <p class="muted">To not lose your current scores, <a href="/" target="_blank" rel="noopener">click here to open the home page in a new tab</a>. You can return to this tab and continue scoring.</p>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:10px">
        <button id="stayBtn">Stay on this page</button>
      </div>
    </div>
  </div>

<script>
  // Session-only keys
  const S_AUTH='wmb.judge.auth.s';
  const S_SCORES='wmb.judge.scores.s';
  const S_NAME='wmb.judge.name.s';
  const S_PWD='wmb.judge.pwd.s';

  const gate=document.getElementById('gate');
  const panel=document.getElementById('panel');
  const nameField=document.getElementById('judgeName');
  const nameTop=document.getElementById('judgeNameTop');
  const pwdField=document.getElementById('judgePwd');
  const msg=document.getElementById('gateMsg');
  const note=document.getElementById('weighingNote');

  const backOverlay=document.getElementById('backOverlay');
  const stayBtn=document.getElementById('stayBtn');

  const rankCard=document.getElementById('ranking');
  const rankBody=document.getElementById('rankBody');

  function saveLocal(d){ sessionStorage.setItem(S_SCORES,JSON.stringify(d)); }
  function getSaved(){ try{return JSON.parse(sessionStorage.getItem(S_SCORES)||'{}')}catch{return{}} }
  function clearAllSession(){
    sessionStorage.removeItem(S_AUTH);
    sessionStorage.removeItem(S_SCORES);
    sessionStorage.removeItem(S_NAME);
    sessionStorage.removeItem(S_PWD);
  }

  async function loadBands(){
    await new Promise((resolve)=>{
      const s=document.createElement('script');
      s.src='/bands.js?v=judges-embed1';
      s.onload=resolve; s.onerror=resolve;
      document.head.appendChild(s);
    });
    return Array.isArray(window.BANDS)?window.BANDS:[];
  }

  async function checkPassword(pwd){
    try{
      const r=await fetch('/api/judge-check',{
        method:'POST',headers:{'content-type':'application/json'},
        body:JSON.stringify({password:pwd})
      });
      return r.ok;
    }catch{return false;}
  }

  function openPanelFresh(){
    sessionStorage.setItem(S_SCORES, JSON.stringify({}));
    gate.classList.add('hidden');
    panel.classList.remove('hidden');
    note.classList.remove('hidden');            // show instruction line
    nameTop.value = nameField.value || '';
    nameTop.addEventListener('input',()=>sessionStorage.setItem(S_NAME,nameTop.value));
    initScoring(true);
    initBackGuard();
  }

  document.getElementById('btnLogin').addEventListener('click', async ()=>{
    msg.textContent='Checking...';
    const pwd = pwdField.value.trim();
    const ok = await checkPassword(pwd);
    if(!ok){ msg.textContent='Wrong password'; return; }
    clearAllSession();
    sessionStorage.setItem(S_PWD, pwd);
    sessionStorage.setItem(S_AUTH, '1');
    sessionStorage.setItem(S_NAME, nameField.value.trim());
    msg.textContent='Unlocked';
    openPanelFresh();
  });

  const WEIGHTS={m:0.40,o:0.25,q:0.20,p:0.15};
  function weighted(m,o,q,p){ return (m*WEIGHTS.m + o*WEIGHTS.o + q*WEIGHTS.q + p*WEIGHTS.p); }

  function esc(s){return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
  function ytId(url){
    if(!url) return null;
    try{
      const u = new URL(url.replace("music.youtube.com","www.youtube.com"));
      const id = u.searchParams.get('v');
      if(id) return id;
      const parts = u.pathname.split('/').filter(Boolean);
      const i = parts.indexOf('shorts');
      if (i !== -1 && parts[i+1]) return parts[i+1];
    }catch(e){}
    return null;
  }
  function spotifyTrackEmbedFromUrl(raw){
    try{
      const u = new URL(raw.replace("?si","/ignore?si"));
      const parts = u.pathname.split("/").filter(Boolean);
      if (parts[0] === "track" && parts[1]) {
        return `https://open.spotify.com/embed/track/${parts[1]}`;
      }
      if (parts[0] === "artist" && parts[1]) {
        return `https://open.spotify.com/embed/artist/${parts[1]}`;
      }
    }catch{}
    return null;
  }

  function link(label, url){ return url ? `<a href="${url}" target="_blank" rel="noopener">${label}</a>` : ''; }

  function bandCard(band, saved){
    const s=saved[band.name]||{m:0,o:0,q:0,p:0,c:''};
    const ready=weighted(s.m,s.o,s.q,s.p);

    // Build social links like on main page
    const websiteUrl = Array.isArray(band.otherLinks) && band.otherLinks.length ? band.otherLinks[0] : "";
    const socials = [
      link('Spotify', band.spotify),
      link('Facebook', band.facebookUrl),
      link('YouTube', band.youtube),
      link('Instagram', band.instagramUrl),
      websiteUrl ? link('Website', websiteUrl) : ''
    ].filter(Boolean).join(' ');

    // Prefer YouTube else Spotify (forced track or artist)
    let media = '';
    const ytid = ytId(band.youtube);
    if (ytid) {
      media = `<iframe allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen src="https://www.youtube-nocookie.com/embed/${ytid}"></iframe>`;
    } else if (band.spotify || band.spotifyEmbedTrack) {
      const forced = band.spotifyEmbedTrack ? spotifyTrackEmbedFromUrl(band.spotifyEmbedTrack) : null;
      const embed = forced || (band.spotify ? spotifyTrackEmbedFromUrl(band.spotify) : null);
      media = embed ? `<iframe allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy" src="${embed}"></iframe>` : '';
    }

    return `
      <article class="band" data-band="${esc(band.name)}">
        <div class="band-head">
          <div>
            <div class="band-name">${esc(band.name)}</div>
            <div class="meta">${esc(band.city||'')}${band.city&&band.genre?' · ':''}${esc(band.genre||'')}</div>
          </div>
          <div class="links">${socials}</div>
        </div>

        <div class="inner">
          ${media ? `<div class="row"><div class="pill">Featured media</div>${media}</div>` : ''}

          <div class="row">
            <label>Musicianship</label>
            <div class="control">
              <input type="range" min="0" max="10" step="1" value="${s.m}" data-k="m">
              <span class="badge" data-kv="m">${s.m}</span>
            </div>
          </div>

          <div class="row">
            <label>Originality</label>
            <div class="control">
              <input type="range" min="0" max="10" step="1" value="${s.o}" data-k="o">
              <span class="badge" data-kv="o">${s.o}</span>
            </div>
          </div>

          <div class="row">
            <label>Online Material Quality</label>
            <div class="control">
              <input type="range" min="0" max="10" step="1" value="${s.q}" data-k="q">
              <span class="badge" data-kv="q">${s.q}</span>
            </div>
          </div>

          <div class="row">
            <label>Online Presence</label>
            <div class="control">
              <input type="range" min="0" max="10" step="1" value="${s.p}" data-k="p">
              <span class="badge" data-kv="p">${s.p}</span>
            </div>
          </div>

          <div class="readiness">
            <span class="muted">Wacken Readiness</span>
            <b data-ready>${ready.toFixed(2)}</b>
          </div>

          <div class="row">
            <label>Comments</label>
            <textarea data-k="c" placeholder="Optional comments">${esc(s.c||'')}</textarea>
          </div>
        </div>
      </article>
    `;
  }

  function hasAnyProgress(){
    const saved = getSaved();
    for (const v of Object.values(saved)){
      if ((v.m|0)!==0 || (v.o|0)!==0 || (v.q|0)!==0 || (v.p|0)!==0 || (v.c||'').trim()!=='') return true;
    }
    return false;
  }

  function initBackGuard(){
    history.pushState({guard:true}, '');
    window.addEventListener('popstate', (ev)=>{
      if (hasAnyProgress()){
        backOverlay.style.display='flex';
        history.pushState({guard:true}, '');
      } else {
        history.back();
      }
    });
    stayBtn.onclick = ()=>{ backOverlay.style.display='none'; };
    window.addEventListener('beforeunload', (e)=>{
      if (hasAnyProgress()){
        e.preventDefault();
        e.returnValue='';
      }
    });
  }

  function recomputeRanking(bands){
    const saved = getSaved();
    const rows = bands.map(b=>{
      const s = saved[b.name] || {m:0,o:0,q:0,p:0};
      return { band:b.name, r: weighted(s.m,s.o,s.q,s.p) };
    }).filter(x=>!Number.isNaN(x.r));

    // Only show if any score exists
    const any = rows.some(x=>x.r>0);
    if (!any){
      rankCard.classList.add('hidden');
      rankBody.innerHTML='';
      return;
    }

    rows.sort((a,b)=>b.r-a.r);
    rankBody.innerHTML = rows.map(r=>`
      <tr><td>${esc(r.band)}</td><td class="right"><b>${r.r.toFixed(2)}</b></td></tr>
    `).join('');
    rankCard.classList.remove('hidden');
  }

  function makePrintableHtml({bands, judge, saved}){
    const rows = bands.map(b=>{
      const s = saved[b.name] || {m:0,o:0,q:0,p:0,c:''};
      const r = weighted(s.m,s.o,s.q,s.p);
      return {name:b.name, m:s.m, o:s.o, q:s.q, p:s.p, r:r, c:(s.c||'')};
    }).sort((a,b)=>b.r-a.r);

    const today = new Date().toLocaleString();
    return `
<!doctype html><html><head>
<meta charset="utf-8"><title>Scoring — ${esc(judge)}</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;color:#111}
  h1{font-size:20px;margin:0 0 4px}
  .meta{color:#444;margin:0 0 12px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 10px;border:1px solid #ccc;font-size:13px;vertical-align:top}
  thead th{background:#f2f2f2;text-transform:uppercase;letter-spacing:.3px}
  .right{text-align:right}
  .small{font-size:12px;color:#444}
</style>
</head><body>
  <h1>Wacken Metal Battle Cyprus — Judge Scores</h1>
  <p class="meta">Judge: <b>${esc(judge||'')}</b> · Exported: ${esc(today)}</p>
  <table>
    <thead>
      <tr>
        <th>Band</th><th class="right">Musicianship</th><th class="right">Originality</th>
        <th class="right">Material</th><th class="right">Presence</th><th class="right">Readiness</th><th>Comments</th>
      </tr>
    </thead>
    <tbody>
      ${rows.map(r=>`
        <tr>
          <td>${esc(r.name)}</td>
          <td class="right">${r.m}</td>
          <td class="right">${r.o}</td>
          <td class="right">${r.q}</td>
          <td class="right">${r.p}</td>
          <td class="right"><b>${r.r.toFixed(2)}</b></td>
          <td>${esc(r.c)}</td>
        </tr>
      `).join('')}
    </tbody>
  </table>
  <p class="small">Weights: 40% Musicianship · 25% Originality · 20% Online Material Quality · 15% Online Presence.</p>
  <script>window.addEventListener('load',()=>{window.print();});</script>
</body></html>`;
  }

  async function initScoring(fresh=false){
    const wrap=document.getElementById('bandsWrap');
    const bands=(await loadBands()).slice().sort((a,b)=>a.name.localeCompare(b.name));

    if (fresh) saveLocal({});

    const saved=getSaved();
    wrap.innerHTML = bands.map(b=>bandCard(b,saved)).join('');

    wrap.querySelectorAll('.band').forEach(card=>{
      const name=card.getAttribute('data-band');
      const set=saved[name]||(saved[name]={m:0,o:0,q:0,p:0,c:''});
      card.querySelectorAll('input[type=range]').forEach(sl=>{
        sl.addEventListener('input',()=>{
          const k=sl.getAttribute('data-k');
          set[k]=Number(sl.value);
          card.querySelector(`[data-kv="${k}"]`).textContent=set[k];
          card.querySelector('[data-ready]').textContent=weighted(set.m,set.o,set.q,set.p).toFixed(2);
          saveLocal(saved);
          recomputeRanking(bands);
        });
      });
      const ta=card.querySelector('textarea');
      ta.addEventListener('input',()=>{ set.c=ta.value; saveLocal(saved); });
    });

    // initial ranking (hidden if no scores)
    recomputeRanking(bands);

    // Reset sliders to zero in place
    document.getElementById('btnResetSliders').onclick = ()=>{
      const blank={};
      wrap.querySelectorAll('.band').forEach(card=>{
        const name=card.getAttribute('data-band');
        blank[name]={m:0,o:0,q:0,p:0,c:''};
        card.querySelectorAll('input[type=range]').forEach(sl=>{
          sl.value=0;
          const k=sl.getAttribute('data-k');
          card.querySelector(`[data-kv="${k}"]`).textContent='0';
        });
        const ready=card.querySelector('[data-ready]'); if (ready) ready.textContent='0.00';
        const ta=card.querySelector('textarea'); if (ta) ta.value='';
      });
      saveLocal(blank);
      recomputeRanking(bands);
    };

    // Download PDF
    document.getElementById('btnDownload').onclick = ()=>{
      const judge = (nameTop.value.trim() || nameField.value.trim());
      const html = makePrintableHtml({bands, judge, saved:getSaved()});
      const blob = new Blob([html], {type:'text/html;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const w = window.open(url, '_blank');
      // Fallback if popup blocked
      if (!w) {
        const a = document.createElement('a');
        a.href = url; a.download = 'wmb-scoring.html';
        document.body.appendChild(a); a.click(); a.remove();
      }
      // URL will be released by the new window on close
    };

    // Submit
    document.getElementById('btnSave').onclick=async()=>{
      const judge = (nameTop.value.trim() || nameField.value.trim());
      if(!judge){ alert('Please enter your name.'); return; }
      const pwd = sessionStorage.getItem(S_PWD)||'';
      if(!pwd){ alert('Your session expired. Please unlock again.'); return; }

      const payload={ judge, password: pwd, scores: getSaved() };
      const r = await fetch('/api/submit-score', {
        method:'POST',
        headers:{'content-type':'application/json'},
        body: JSON.stringify(payload)
      });
      if(r.ok){
        const toast = document.createElement('div');
        toast.textContent = 'Thank you — scores submitted';
        toast.style.cssText = 'position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#2a6b3a;color:#fff;padding:16px 18px;border-radius:12px;border:1px solid #1f4e2b;font-size:18px;z-index:9999';
        document.body.appendChild(toast);
        setTimeout(()=>{ window.location.href = '/'; }, 1200);
      } else {
        alert('Could not save. Check password or connection.');
      }
    };
  }

  function hasAnyScores(d){ return Object.values(d||{}).some(v => (v.m|0)!==0 || (v.o|0)!==0 || (v.q|0)!==0 || (v.p|0)!==0 || (v.c||'').trim()!==''); }
</script>
</body>
</html>
