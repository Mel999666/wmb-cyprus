<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Judging Panel — Wacken Metal Battle Cyprus</title>
<style>
  :root{
    --bg:#0a0a0b; --panel:#151215; --text:#f2f2f2; --muted:#b8b6bb;
    --line:#2b2023; --ring:rgba(255,90,31,.35);
    --maroon-1:#c01722; --maroon-2:#8b0f17; --maroon-border:#6b0c12;
    --card-bg:#120f10; /* matches main page band cards */
    --pill-bg:#1a1416;
    --link:#ff5a1f;
    --ok:#2a6b3a; --ok-border:#1f4e2b;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:linear-gradient(180deg,#0d0b0d,#080708 65%);
    color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
  }
  .container{max-width:1140px;margin:0 auto;padding:20px}

  /* Generic card */
  .card{
    background:linear-gradient(180deg,#181316,#110f10);
    border:1px solid var(--line);
    border-radius:16px;
    padding:16px;
    box-shadow:0 18px 40px rgba(0,0,0,.45)
  }

  /* Password gate in maroon */
  #gate.card{
    background:linear-gradient(180deg,var(--maroon-1),var(--maroon-2));
    border-color:var(--maroon-border); color:#fff;
  }
  #gate h2{margin:0}
  #gate input[type=text], #gate input[type=password]{
    background:rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.2); color:#fff;
  }
  #gate input::placeholder{color:rgba(255,255,255,.8)}

  .h1{font-size:clamp(22px,3.2vw,34px);font-weight:800;margin:0 0 6px}
  .muted{color:var(--muted)}
  a{color:#ffd7c3;text-decoration:none}

  input[type=text],input[type=password]{background:#0f0d0e;border:1px solid var(--line);
    color:var(--text);padding:10px 12px;border-radius:10px;min-width:220px}
  button{background:#2a6b3a;border:none;color:#fff;padding:10px 14px;border-radius:12px;cursor:pointer}
  button.secondary{background:#1a1416;border:1px solid var(--line);color:#fff}
  button.warn{background:#7a2626}
  button:focus,input:focus,textarea:focus{outline:2px solid var(--ring);outline-offset:2px}

  .login{display:grid;gap:12px;max-width:560px;margin:28px auto}
  .hidden{display:none}

  /* ===== Band card styling to mirror main page ===== */
  .band{border:1px solid var(--line);border-radius:16px;overflow:hidden;background:var(--card-bg);margin-bottom:18px}
  .band-head{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;
    background:linear-gradient(180deg,rgba(179,18,31,.18),transparent)}
  .band-name{font-weight:800;font-size:18px}
  .band-meta{color:var(--muted);font-size:13px}
  .band-body{padding:14px 16px;display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
  @media (max-width:900px){ .band-body{grid-template-columns:1fr;}}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:var(--pill-bg);border:1px solid var(--line);color:#ccc;font-size:12px}
  iframe{border:none;border-radius:12px;min-height:180px;background:#000;width:100%}

  .row{display:grid;gap:8px;margin:10px 0}
  .row label{font-size:14px;font-weight:600}
  .control{display:flex;gap:10px;align-items:center}
  .control input[type=range]{width:100%}
  .badge{background:#1a1416;border:1px solid var(--line);border-radius:10px;padding:6px 10px;min-width:48px;text-align:center}

  .stats{display:grid;gap:8px}
  .stat{display:flex;justify-content:space-between;border:1px solid var(--line);border-radius:12px;padding:10px 12px;background:#100d0e}
  .stat b{font-weight:700}

  .readiness{display:flex;justify-content:space-between;align-items:center;margin-top:8px;border-top:1px solid var(--line);padding-top:10px}
  .readiness b{font-size:16px}

  textarea{width:100%;min-height:70px;resize:vertical;background:#0f0d0e;border:1px solid var(--line);color:#fff;border-radius:10px;padding:10px}

  /* Explainers as maroon chips with rounded corners */
  .explainers{display:grid;gap:10px;margin:12px 0}
  .ex-item{display:grid;gap:6px;border:1px solid var(--maroon-border);border-radius:12px;padding:12px;
           background:linear-gradient(180deg,rgba(179,18,31,.22),rgba(139,15,23,.08))}
  .ex-item b{font-weight:800}

  .weighting-line{font-weight:800;font-style:italic;margin:10px 0 0}

  /* Bottom action bar */
  .bottom-actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end;margin-top:14px}

  /* Back-warning overlay */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:9999}
  .overlay .box{background:#181316;border:1px solid var(--line);border-radius:14px;padding:16px;max-width:560px}
  .overlay .box h3{margin:0 0 8px}

  /* Centered success modal */
  .success-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:10000}
  .success-modal .inner{background:var(--ok);border:1px solid var(--ok-border);color:#fff;padding:18px 22px;border-radius:14px;font-size:18px;box-shadow:0 10px 30px rgba(0,0,0,.5)}

  /* Ranking table (judge preview) */
  .rank-card{margin-top:16px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px 12px;border-bottom:1px solid var(--line)}
  thead th{font-size:13px;text-transform:uppercase;letter-spacing:.35px;color:#ffefe9;background:linear-gradient(180deg,rgba(179,18,31,.22),rgba(139,15,23,.08))}
  .right{text-align:right}
</style>
</head>
<body>
  <div class="container">
    <h1 class="h1">Judging Panel — Wacken Metal Battle Cyprus</h1>
    <p class="weighting-line">Score each band from 0 to 10. Wacken Readiness is a weighted score: 40% Musicianship, 25% Originality, 20% Online Material Quality, 15% Online Presence.</p>

    <!-- Password gate -->
    <section id="gate" class="card login">
      <h2>Enter judging password</h2>
      <input id="judgeName" type="text" placeholder="Your name e.g. Maria K." autocomplete="name">
      <input id="judgePwd" type="password" placeholder="Judge password" autocomplete="current-password">
      <div style="display:flex;gap:10px;align-items:center">
        <button id="btnLogin">Unlock scoring</button>
        <span id="gateMsg" class="muted"></span>
      </div>
    </section>

    <!-- Panel -->
    <section id="panel" class="hidden">
      <div class="card">
        <div class="explainers">
          <div class="ex-item"><b>Musicianship 40%</b><div>Technical skill, timing, tightness, vocal control, compositional ability.</div></div>
          <div class="ex-item"><b>Originality 25%</b><div>Distinctive sound or concept, songwriting ideas, creativity, not derivative.</div></div>
          <div class="ex-item"><b>Online Material Quality 20%</b><div>Quality of videos and recordings, presentation, professionalism of artwork or photos.</div></div>
          <div class="ex-item"><b>Online Presence 15%</b><div>Engagement and following across platforms, posting consistency, communication with fans.</div></div>
        </div>
      </div>

      <div id="bandsWrap"></div>

      <!-- Judge ranking preview (hidden until all bands touched) -->
      <section id="rankPreview" class="card rank-card hidden">
        <h3 style="margin:0 0 10px">Your current ranking (by Wacken Readiness)</h3>
        <div style="overflow:auto">
          <table aria-label="Judge ranking table">
            <thead>
              <tr>
                <th>Band</th>
                <th class="right">Musicianship</th>
                <th class="right">Originality</th>
                <th class="right">Material</th>
                <th class="right">Presence</th>
                <th class="right">Readiness</th>
              </tr>
            </thead>
            <tbody id="rankBody"></tbody>
          </table>
        </div>
      </section>

      <div class="card bottom-actions">
        <input id="judgeNameTop" type="text" placeholder="Judge name" />
        <button id="btnResetSliders" class="warn">Refresh your scores & start again</button>
        <button id="btnDownload" class="secondary">Download your completed scoring card</button>
        <button id="btnSave">Submit your Scores</button>
      </div>
    </section>
  </div>

  <!-- back warning overlay -->
  <div id="backOverlay" class="overlay">
    <div class="box">
      <h3>Leaving the scoring page</h3>
      <p class="muted">To not lose your current scores, <a href="/" target="_blank" rel="noopener">click here to open the home page in a new tab</a>. You can return to this tab and continue scoring.</p>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:10px">
        <button id="stayBtn">Stay on this page</button>
      </div>
    </div>
  </div>

  <!-- centered success modal -->
  <div id="successModal" class="success-modal">
    <div class="inner">Thank you — scores submitted</div>
  </div>

<script>
  // Session-only keys
  const S_AUTH='wmb.judge.auth.s';
  const S_SCORES='wmb.judge.scores.s';
  const S_NAME='wmb.judge.name.s';
  const S_PWD='wmb.judge.pwd.s';

  const gate=document.getElementById('gate');
  const panel=document.getElementById('panel');
  const nameField=document.getElementById('judgeName');
  const nameTop=document.getElementById('judgeNameTop');
  const pwdField=document.getElementById('judgePwd');
  const msg=document.getElementById('gateMsg');

  const backOverlay=document.getElementById('backOverlay');
  const stayBtn=document.getElementById('stayBtn');
  const successModal=document.getElementById('successModal');

  const rankPreview=document.getElementById('rankPreview');
  const rankBody=document.getElementById('rankBody');

  function saveLocal(d){ sessionStorage.setItem(S_SCORES,JSON.stringify(d)); }
  function getSaved(){ try{return JSON.parse(sessionStorage.getItem(S_SCORES)||'{}')}catch{return{}} }
  function clearAllSession(){
    sessionStorage.removeItem(S_AUTH);
    sessionStorage.removeItem(S_SCORES);
    sessionStorage.removeItem(S_NAME);
    sessionStorage.removeItem(S_PWD);
  }

  async function loadBands(){
    await new Promise((resolve)=>{
      const s=document.createElement('script');
      s.src='/bands.js?v=judges-embed2';
      s.onload=resolve; s.onerror=resolve;
      document.head.appendChild(s);
    });
    return Array.isArray(window.BANDS)?window.BANDS:[];
  }

  async function checkPassword(pwd){
    try{
      const r=await fetch('/api/judge-check',{
        method:'POST',headers:{'content-type':'application/json'},
        body:JSON.stringify({password:pwd})
      });
      return r.ok;
    }catch{return false;}
  }

  function openPanelFresh(){
    sessionStorage.setItem(S_SCORES, JSON.stringify({}));
    gate.classList.add('hidden');
    panel.classList.remove('hidden');
    nameTop.value = nameField.value || '';
    nameTop.addEventListener('input',()=>sessionStorage.setItem(S_NAME,nameTop.value));
    initScoring(true);
    initBackGuard();
  }

  document.getElementById('btnLogin').addEventListener('click', async ()=>{
    msg.textContent='Checking...';
    const pwd = pwdField.value.trim();
    const ok = await checkPassword(pwd);
    if(!ok){ msg.textContent='Wrong password'; return; }
    clearAllSession();
    sessionStorage.setItem(S_PWD, pwd);
    sessionStorage.setItem(S_AUTH, '1');
    sessionStorage.setItem(S_NAME, nameField.value.trim());
    msg.textContent='Unlocked';
    openPanelFresh();
  });

  const WEIGHTS={m:0.40,o:0.25,q:0.20,p:0.15};
  function weighted(m,o,q,p){ return (m*WEIGHTS.m + o*WEIGHTS.o + q*WEIGHTS.q + p*WEIGHTS.p).toFixed(2); }

  function esc(s){return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
  function ytId(url){
    if(!url) return null;
    try{
      const u = new URL(url.replace("music.youtube.com","www.youtube.com"));
      const id = u.searchParams.get('v');
      if(id) return id;
      const parts = u.pathname.split('/').filter(Boolean);
      const i = parts.indexOf('shorts');
      if (i !== -1 && parts[i+1]) return parts[i+1];
    }catch(e){}
    return null;
  }
  function spotifyTrackEmbedFromUrl(raw){
    try{
      const u = new URL(raw.replace("?si","/ignore?si"));
      const parts = u.pathname.split("/").filter(Boolean);
      if (parts[0] === "track" && parts[1]) return `https://open.spotify.com/embed/track/${parts[1]}`;
      if (parts[0] === "artist" && parts[1]) return `https://open.spotify.com/embed/artist/${parts[1]}`;
    }catch{}
    return null;
  }

  // track “touched” sliders to know when every band has been attended
  let touched = {}; // { bandName: {m:true,o:true,q:true,p:true} }

  function bandCard(band, saved){
    const s=saved[band.name]||{m:0,o:0,q:0,p:0,c:''};
    const ready=weighted(s.m,s.o,s.q,s.p);

    let media = '';
    const ytid = ytId(band.youtube);
    if (ytid) {
      media = `<iframe allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen src="https://www.youtube-nocookie.com/embed/${ytid}"></iframe>`;
    } else if (band.spotify || band.spotifyEmbedTrack) {
      const forced = band.spotifyEmbedTrack ? spotifyTrackEmbedFromUrl(band.spotifyEmbedTrack) : null;
      const embed = forced || (band.spotify ? spotifyTrackEmbedFromUrl(band.spotify) : null);
      media = embed ? `<iframe allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy" src="${embed}"></iframe>` : '';
    }

    return `
      <article class="band">
        <div class="band-head">
          <div>
            <div class="band-name">${esc(band.name)}</div>
            <div class="band-meta">${esc(band.city||'')}${band.city&&band.genre?' · ':''}${esc(band.genre||'')}</div>
          </div>
        </div>
        <div class="band-body">
          <div>
            ${media ? `<div class="pill" style="margin-bottom:6px">Featured media</div>${media}` : ''}
          </div>
          <div class="stats">
            <div class="row">
              <label>Musicianship</label>
              <div class="control">
                <input type="range" min="0" max="10" step="1" value="${s.m}" data-k="m" data-band="${esc(band.name)}">
                <span class="badge" data-kv="m" data-band="${esc(band.name)}">${s.m}</span>
              </div>
            </div>
            <div class="row">
              <label>Originality</label>
              <div class="control">
                <input type="range" min="0" max="10" step="1" value="${s.o}" data-k="o" data-band="${esc(band.name)}">
                <span class="badge" data-kv="o" data-band="${esc(band.name)}">${s.o}</span>
              </div>
            </div>
            <div class="row">
              <label>Online Material Quality</label>
              <div class="control">
                <input type="range" min="0" max="10" step="1" value="${s.q}" data-k="q" data-band="${esc(band.name)}">
                <span class="badge" data-kv="q" data-band="${esc(band.name)}">${s.q}</span>
              </div>
            </div>
            <div class="row">
              <label>Online Presence</label>
              <div class="control">
                <input type="range" min="0" max="10" step="1" value="${s.p}" data-k="p" data-band="${esc(band.name)}">
                <span class="badge" data-kv="p" data-band="${esc(band.name)}">${s.p}</span>
              </div>
            </div>
            <div class="readiness">
              <span class="muted">Wacken Readiness</span>
              <b data-ready data-band="${esc(band.name)}">${ready}</b>
            </div>
            <div class="row">
              <label>Comments</label>
              <textarea data-k="c" data-band="${esc(band.name)}" placeholder="Optional comments">${esc(s.c||'')}</textarea>
            </div>
          </div>
        </div>
      </article>
    `;
  }

  function hasAnyProgress(){
    const saved = getSaved();
    for (const v of Object.values(saved)){
      if ((v.m|0)!==0 || (v.o|0)!==0 || (v.q|0)!==0 || (v.p|0)!==0 || (v.c||'').trim()!=='') return true;
    }
    return false;
  }

  function allBandsTouchedAll(bands){
    return bands.every(b=>{
      const t=touched[b.name];
      return t && t.m && t.o && t.q && t.p;
    });
  }

  function renderRankPreview(bands){
    const saved = getSaved();
    const rows = bands.map(b=>{
      const s=saved[b.name]||{m:0,o:0,q:0,p:0};
      return {
        band:b.name,
        m:+s.m||0, o:+s.o||0, q:+s.q||0, p:+s.p||0,
        r:+weighted(+s.m||0,+s.o||0,+s.q||0,+s.p||0)
      };
    }).sort((a,b)=>b.r-a.r);

    rankBody.innerHTML = rows.map(r=>`
      <tr>
        <td>${esc(r.band)}</td>
        <td class="right">${r.m.toFixed(0)}</td>
        <td class="right">${r.o.toFixed(0)}</td>
        <td class="right">${r.q.toFixed(0)}</td>
        <td class="right">${r.p.toFixed(0)}</td>
        <td class="right"><b>${Number(r.r).toFixed(2)}</b></td>
      </tr>
    `).join('');
    rankPreview.classList.remove('hidden');
  }

  function initBackGuard(){
    history.pushState({guard:true}, '');
    window.addEventListener('popstate', (ev)=>{
      if (hasAnyProgress()){
        backOverlay.style.display='flex';
        history.pushState({guard:true}, '');
      } else {
        history.back();
      }
    });
    stayBtn.onclick = ()=>{ backOverlay.style.display='none'; };
    window.addEventListener('beforeunload', (e)=>{
      if (hasAnyProgress()){
        e.preventDefault();
        e.returnValue='';
      }
    });
  }

  async function initScoring(fresh=false){
    const wrap=document.getElementById('bandsWrap');
    const bands=(await loadBands()).slice().sort((a,b)=>a.name.localeCompare(b.name));

    if (fresh) saveLocal({});

    const saved=getSaved();
    touched = {};
    wrap.innerHTML = bands.map(b=>bandCard(b,saved)).join('');

    // wire up sliders and comments
    wrap.querySelectorAll('input[type=range]').forEach(sl=>{
      sl.addEventListener('input',()=>{
        const k=sl.getAttribute('data-k');
        const band=sl.getAttribute('data-band');
        const data=getSaved(); const set=data[band]||(data[band]={m:0,o:0,q:0,p:0,c:''});
        set[k]=Number(sl.value);
        // badge
        const badge = wrap.querySelector(`.badge[data-kv="${k}"][data-band="${CSS.escape(band)}"]`);
        if (badge) badge.textContent=set[k];
        // readiness
        const readyEl = wrap.querySelector(`[data-ready][data-band="${CSS.escape(band)}"]`);
        if (readyEl) readyEl.textContent=weighted(set.m,set.o,set.q,set.p);
        saveLocal(data);
        // touched
        (touched[band]||(touched[band]={}))[k]=true;
        if (allBandsTouchedAll(bands)) renderRankPreview(bands);
      });
    });
    wrap.querySelectorAll('textarea[data-k="c"]').forEach(ta=>{
      ta.addEventListener('input',()=>{
        const band=ta.getAttribute('data-band');
        const data=getSaved(); const set=data[band]||(data[band]={m:0,o:0,q:0,p:0,c:''});
        set.c=ta.value; saveLocal(data);
      });
    });

    // reset sliders to zero in place
    document.getElementById('btnResetSliders').onclick = ()=>{
      const blank={};
      bands.forEach(b=>{
        blank[b.name]={m:0,o:0,q:0,p:0,c:''};
      });
      saveLocal(blank);
      touched={};
      // UI
      wrap.querySelectorAll('input[type=range]').forEach(sl=>{
        sl.value=0;
        const k=sl.getAttribute('data-k');
        const band=sl.getAttribute('data-band');
        const badge = wrap.querySelector(`.badge[data-kv="${k}"][data-band="${CSS.escape(band)}"]`);
        if (badge) badge.textContent='0';
      });
      wrap.querySelectorAll('[data-ready]').forEach(el=>el.textContent='0.00');
      wrap.querySelectorAll('textarea[data-k="c"]').forEach(ta=>{ ta.value=''; });
      rankPreview.classList.add('hidden');
      rankBody.innerHTML='';
    };

    // download scoring card (printable -> Save as PDF)
    document.getElementById('btnDownload').onclick = ()=>{
      const judge = (nameTop.value.trim() || nameField.value.trim() || 'Anonymous');
      const data = getSaved();
      // build rows
      const rows = bands.map(b=>{
        const s=data[b.name]||{m:0,o:0,q:0,p:0,c:''};
        const r=weighted(+s.m||0,+s.o||0,+s.q||0,+s.p||0);
        return {band:b.name, ...s, r};
      }).sort((a,b)=>b.r-a.r);

      const html = `
<!doctype html><html><head><meta charset="utf-8">
<title>${judge} — WMB Scoring Card</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;padding:24px}
  h1{margin:0 0 8px}
  .meta{color:#555;margin-bottom:14px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 10px;border-bottom:1px solid #ddd;font-size:14px}
  th{background:#f5f5f5;text-transform:uppercase;letter-spacing:.3px;font-size:12px}
  .right{text-align:right}
  @media print{ .noprint{display:none} }
</style></head><body>
  <h1>Wacken Metal Battle Cyprus — Scoring Card</h1>
  <div class="meta">Judge: <b>${judge}</b> • Generated: ${new Date().toLocaleString()}</div>
  <table>
    <thead>
      <tr><th>#</th><th>Band</th><th class="right">M</th><th class="right">O</th><th class="right">Q</th><th class="right">P</th><th class="right">Readiness</th><th>Comments</th></tr>
    </thead>
    <tbody>
      ${rows.map((r,i)=>`
        <tr>
          <td class="right">${i+1}</td>
          <td>${r.band.replace(/&/g,'&amp;').replace(/</g,'&lt;')}</td>
          <td class="right">${(+r.m||0).toFixed(0)}</td>
          <td class="right">${(+r.o||0).toFixed(0)}</td>
          <td class="right">${(+r.q||0).toFixed(0)}</td>
          <td class="right">${(+r.p||0).toFixed(0)}</td>
          <td class="right">${Number(r.r).toFixed(2)}</td>
          <td>${(r.c||'').replace(/&/g,'&amp;').replace(/</g,'&lt;')}</td>
        </tr>`).join('')}
    </tbody>
  </table>
  <div class="noprint" style="margin-top:14px">
    <button onclick="window.print()">Print / Save as PDF</button>
  </div>
</body></html>`;
      const blob = new Blob([html], {type:'text/html'});
      const url = URL.createObjectURL(blob);
      const w = window.open(url, '_blank');
      if (w) {
        w.focus();
        // optional auto-print
        w.addEventListener('load', ()=>{ try{ w.print(); }catch{} });
      }
    };

    // submit
    document.getElementById('btnSave').onclick=async()=>{
      const judge = (nameTop.value.trim() || nameField.value.trim());
      if(!judge){ alert('Please enter your name.'); return; }
      const pwd = sessionStorage.getItem(S_PWD)||'';
      if(!pwd){ alert('Your session expired. Please unlock again.'); return; }

      const payload={ judge, password: pwd, scores: getSaved() };
      const r = await fetch('/api/submit-score', {
        method:'POST',
        headers:{'content-type':'application/json'},
        body: JSON.stringify(payload)
      });
      if(r.ok){
        successModal.style.display='flex';
        setTimeout(()=>{ window.location.href = '/'; }, 1400);
      } else {
        alert('Could not save. Check password or connection.');
      }
    };

    // show preview if already complete (edge case: refresh)
    if (allBandsTouchedAll(bands)) renderRankPreview(bands);
  }
</script>
</body>
</html>
