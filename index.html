<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wacken Metal Battle Cyprus — Applications</title>
  <meta name="description" content="Public showcase of bands that applied for Wacken Metal Battle Cyprus." />
  <style>
    :root{
      --bg:#0a0a0b;--panel:#151215;--text:#f2f2f2;--muted:#b8b6bb;
      --red:#8b0f17;--crimson:#b3121f;--lava:#ff5a1f;--ring:rgba(255,90,31,0.35);
      --green:#2a6b3a;
      --maroon-1:#e05563; --maroon-2:#c21a25; --maroon-3:#8f1220; --maroon-text:#d86a74;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:
        radial-gradient(1200px 640px at 50% -10%,rgba(255,90,31,.08),transparent),
        linear-gradient(180deg,#0d0b0d,#080708 65%);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
    }
    a{color:var(--text);text-decoration:none}
    a:focus{outline:2px solid var(--ring);outline-offset:3px;border-radius:8px}
    img{max-width:100%;display:block}
    header{
      position:sticky;top:0;z-index:50;
      background:linear-gradient(180deg,rgba(10,10,11,.9),rgba(10,10,11,.65));
      border-bottom:1px solid #231a1d;backdrop-filter:blur(8px)
    }
    .container{max-width:1140px;margin:0 auto;padding:20px}
    .nav{display:flex;align-items:center;gap:16px}
    .site-title{font-size:clamp(22px,4vw,36px);font-weight:800;letter-spacing:.3px}
    .logo{width:84px;height:auto;filter:drop-shadow(0 8px 18px rgba(0,0,0,.6))}
    .section{padding:28px 0}
    .card{
      background:linear-gradient(180deg,#181316,#110f10);
      border:1px solid #2b2023;border-radius:16px;padding:20px;
      box-shadow:0 18px 40px rgba(0,0,0,.45)
    }
    .h2{font-size:22px;margin:0 0 10px;font-weight:800}
    .lead{color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 12px;border-bottom:1px solid #2b2023}
    thead th{
      font-size:14px;text-transform:uppercase;letter-spacing:.4px;color:#ffefe9;
      background:linear-gradient(180deg,rgba(179,18,31,.25),rgba(139,15,23,.08))
    }
    tbody tr:hover{background:rgba(179,18,31,.08)}
    .boards{display:grid;grid-template-columns:repeat(2,1fr);gap:18px}
    @media (max-width:800px){.boards{grid-template-columns:1fr}}
    .board h3{margin:0 0 8px;color:#fff;font-weight:700}
    .rank-list{list-style:none;margin:0;padding:0}
    .rank-list li{
      display:flex;justify-content:space-between;gap:12px;padding:10px 12px;
      border:1px solid #2b2023;border-radius:12px;margin-bottom:8px;background:#120e0f
    }
    .rank-list li span:first-child{font-weight:700}
    .rank-list li .meta{color:var(--muted)}
    .band-card{border:1px solid #2b2023;border-radius:16px;overflow:hidden;background:#120f10;margin-bottom:18px}
    .band-head{
      display:flex;justify-content:space-between;align-items:center;
      padding:14px 16px;background:linear-gradient(180deg,rgba(179,18,31,.18),transparent)
    }
    .band-name{font-weight:800;font-size:18px}
    .links{display:flex;gap:12px;flex-wrap:wrap}
    .links a{font-size:13px;color:#ff5a1f}
    .band-body{padding:14px 16px;display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
    .subhead{margin:10px 0 6px;font-weight:700;color:#ffefe9}
    .pill{
      display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;
      background:#1a1416;border:1px solid #2b2023;color:var(--muted);font-size:12px
    }
    .stats{display:grid;gap:8px}
    .stat{
      display:flex;justify-content:space-between;border:1px solid #2b2023;border-radius:12px;
      padding:10px 12px;background:#100d0e
    }
    .stat b{font-weight:700}
    iframe{border:none;border-radius:12px;min-height:180px;background:#000;width:100%}
    /* Spotify slot height (official small player) */
    .spotify-slot iframe{height:152px;min-height:152px;background:transparent}
    .nav-btn{
      display:inline-flex;align-items:center;gap:8px;
      background: var(--maroon-3); color:#fff; border:1px solid var(--maroon-3);
      padding:10px 16px; border-radius:12px; font-weight:400; font-size:16px;
    }
    .nav-btn:hover{ filter: brightness(1.05) }
    .cta{
      display:block;margin:16px 0 4px;padding:14px 18px;border-radius:12px;
      border:1px solid #2b2023;background:#1a1416;color:#ffefe9;text-align:center;font-weight:700
    }
    .cta.green{background:var(--green);border-color:var(--green);color:#fff}
    .cta.green:hover{filter:brightness(1.05)}
    footer{border-top:1px solid #2b2023;color:var(--muted)}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <div class="container nav">
      <img class="logo" src="/public/wmb-logo.png?v=2" alt="Wacken Metal Battle Cyprus logo">
      <div class="site-title">Wacken Metal Battle Cyprus</div>
      <nav style="margin-left:auto;display:flex;gap:12px">
        <a href="/judge.html" class="nav-btn">Judges</a>
        <a href="/results.html" class="nav-btn">Admin only</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="section card" id="summary">
      <div class="h2">Applications</div>
      <p class="lead"><span class="pill">Total</span> <b id="totalCount">0</b></p>
      <div style="overflow:auto">
        <table aria-label="Alphabetical list of bands">
          <thead><tr><th>Band</th><th>City</th><th>Genre</th></tr></thead>
          <tbody id="alphabetical"></tbody>
        </table>
      </div>
    </section>

    <section class="section" id="bands"></section>

    <section class="section card" id="leaderboards">
      <div class="h2">Leaderboards</div>
      <div class="boards">
        <div class="board"><h3>Artist Popularity Score on Spotify (0-100)</h3><ol class="rank-list" id="board-spotify"></ol></div>
        <div class="board"><h3>Facebook followers</h3><ol class="rank-list" id="board-facebook"></ol></div>
        <div class="board"><h3>YouTube video views</h3><ol class="rank-list" id="board-youtube"></ol></div>
        <div class="board"><h3>Instagram followers</h3><ol class="rank-list" id="board-instagram"></ol></div>
      </div>
      <a class="cta green" href="/judge.html">Go to Judges Scoring Page</a>
    </section>
  </main>

  <footer>
    <div class="container" style="padding:20px 0;display:flex;justify-content:space-between;gap:14px;flex-wrap:wrap">
      <span>© <span id="year"></span> Wacken Metal Battle Cyprus</span>
      <a class="muted" href="https://www.instagram.com/rockisland_events/" target="_blank" rel="noopener">
        Created by Rock Island Events
      </a>
    </div>
  </footer>

  <!-- bump query so browsers fetch latest -->
  <script src="/bands.js?v=artistpop6"></script>
  <script>
    const STATS = Object.create(null);
    const BANDS = Array.isArray(window.BANDS) ? window.BANDS : [];

    /* ---------- helpers ---------- */
    function byName(a,b){ return a.name.localeCompare(b.name); }

    function ytId(url){
      if(!url) return null;
      try{
        const u = new URL(url.replace("music.youtube.com","www.youtube.com"));
        const v = u.searchParams.get('v');
        if(v) return v;
        const parts = u.pathname.split('/').filter(Boolean);
        const i = parts.indexOf('shorts');
        if (i !== -1 && parts[i+1]) return parts[i+1];
        if (u.hostname === 'youtu.be' && parts[0]) return parts[0];
      }catch(e){}
      return null;
    }

    // Build a clean Spotify EMBED URL from any track URL you paste in bands.js
    function toSpotifyEmbedTrack(raw){
      if (!raw) return null;
      try{
        const u = new URL(raw);
        if (!/open\.spotify\.com$/.test(u.hostname)) return null;
        const segs = u.pathname.split('/').filter(Boolean);
        const idx = segs.indexOf('track');
        if (idx !== -1 && segs[idx+1]) {
          const id = segs[idx+1].split('?')[0];
          return {
            embed: `https://open.spotify.com/embed/track/${id}`,
            href: `https://open.spotify.com/track/${id}`
          };
        }
      }catch(e){}
      return null;
    }

    function isSpotifyArtistUrl(u){
      try{
        const x = new URL(u);
        if (!/open\.spotify\.com$/.test(x.hostname)) return false;
        const segs = x.pathname.split('/').filter(Boolean);
        const idx = segs.indexOf('artist');
        return idx !== -1 && !!segs[idx+1];
      }catch{return false;}
    }

    /* ---------- manual stats & bios ---------- */
    function applyManualStats() {
      for (const b of BANDS) {
        if (!b.manualStats) continue;
        if (!STATS[b.name]) STATS[b.name] = {};
        const m = b.manualStats;
        if (Number.isFinite(m.instagramFollowers)) STATS[b.name].instagramFollowers = Number(m.instagramFollowers);
        if (Number.isFinite(m.facebookFollowers)) STATS[b.name].facebookFollowers = Number(m.facebookFollowers);
        const bioText = (typeof m.bio === "string" && m.bio.trim())
          ? m.bio.trim()
          : (typeof b.bio === "string" && b.bio.trim() ? b.bio.trim() : "");
        if (bioText) STATS[b.name].bio = bioText;
      }
    }

    function mountSpotifyWithFallback(slotEl, embedUrl, hrefUrl){
      // Clear anything in the slot
      slotEl.innerHTML = "";
      // Build iframe
      const ifr = document.createElement("iframe");
      ifr.src = embedUrl + "?utm_source=generator";
      ifr.width = "100%";
      ifr.height = "152";
      ifr.loading = "lazy";
      ifr.allow = "autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture";
      ifr.referrerPolicy = "no-referrer-when-downgrade";

      let loaded = false;
      const done = () => { loaded = true; };

      ifr.addEventListener("load", done);
      // Append and start a timeout watchdog
      slotEl.appendChild(ifr);

      // If the iframe hasn't fired load after 8s, show a simple fallback link
      setTimeout(() => {
        if (!loaded) {
          slotEl.innerHTML =
            `<a href="${hrefUrl}" target="_blank" rel="noopener"
               style="display:inline-block;padding:10px 14px;border-radius:10px;border:1px solid #2b2023;background:#1a1416;color:#ffefe9;font-weight:600">
               Open on Spotify
             </a>`;
        }
      }, 8000);
    }

    function patchBandCard(name){
      const data = STATS[name] || {};
      const card = document.querySelector(`[data-band="${CSS.escape(name)}"]`);
      if (!card) return;

      const sp = card.querySelector("[data-slot=spotify]");
      const spTitle = card.querySelector("[data-slot=spotifyTitle]");
      const bio = card.querySelector("[data-slot=bio]");

      if (sp && data.spotifyEmbed && data.spotifyHref) {
        mountSpotifyWithFallback(sp, data.spotifyEmbed, data.spotifyHref);
      }

      if (spTitle && data.trackName) spTitle.textContent = data.trackName;
      if (bio && data.bio) bio.textContent = data.bio;

      ["instagramFollowers","facebookFollowers","youtubeViews","spotifyPopularity"].forEach(key=>{
        const el = card.querySelector(`[data-stat="${key}"]`);
        if (el) el.textContent = (data[key] || 0).toLocaleString();
      });
    }

    function patchAllCardsFromStats(){
      for (const b of BANDS) patchBandCard(b.name);
    }

    /* ---------- render ---------- */
    function renderSummary(){
      document.getElementById('totalCount').textContent = BANDS.length;
      const tb = document.getElementById('alphabetical');
      tb.innerHTML = [...BANDS].sort(byName)
        .map(b=>`<tr><td>${b.name}</td><td>${b.city||''}</td><td>${b.genre||''}</td></tr>`).join('');
    }

    function metric(name, key){ return (STATS[name] && Number(STATS[name][key])) || 0; }

    function renderBoards(){
      const metrics = [
        { key:'spotifyPopularity', target:'board-spotify', label:'score' },
        { key:'facebookFollowers', target:'board-facebook', label:'followers' },
        { key:'youtubeViews', target:'board-youtube', label:'views' },
        { key:'instagramFollowers', target:'board-instagram', label:'followers' },
      ];
      metrics.forEach(m => {
        const list = [...BANDS]
          .map(b=>({ name:b.name, val:metric(b.name,m.key) }))
          .sort((a,b)=>b.val-a.val)
          .slice(0,6);
        document.getElementById(m.target).innerHTML =
          list.map((row,i)=>`<li><span>${i+1}. ${row.name}</span><span class="meta">${row.val.toLocaleString()} ${m.label}</span></li>`).join('');
      });
    }

    function link(label, url){ return url ? `<a href="${url}" target="_blank" rel="noopener">${label}</a>` : ''; }

    function bandCardHTML(b){
      const featuredId = ytId(b.youtube);
      const liveId = ytId(b.liveYoutube || b.liveVideo || b.live);
      const sameVideo = featuredId && liveId && featuredId === liveId;

      const featured = featuredId
        ? `<iframe allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen src="https://www.youtube-nocookie.com/embed/${featuredId}"></iframe>`
        : `<div class="stat">No featured video</div>`;

      const live = liveId && !sameVideo
        ? `<div class="subhead">Live video</div><iframe allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen src="https://www.youtube-nocookie.com/embed/${liveId}"></iframe>`
        : ``;

      const websiteUrl = Array.isArray(b.otherLinks) && b.otherLinks.length ? b.otherLinks[0] : "";
      const socials = [
        link('Spotify', b.spotifyArtist || b.spotify),
        link('Facebook', b.facebookUrl),
        link('YouTube', b.youtube),
        link('Instagram', b.instagramUrl),
        websiteUrl ? link('Website', websiteUrl) : ''
      ].filter(Boolean).join(' ');

      return `
        <article class="band-card" data-band="${b.name}">
          <div class="band-head">
            <div>
              <div class="band-name">${b.name}</div>
              <div class="muted">${b.city ? b.city+" · " : ""}${b.genre||""}</div>
            </div>
            <div class="links">${socials}</div>
          </div>
          <div class="band-body">
            <div>
              <div class="pill">Featured video</div>
              ${featured}
              ${live}
              <div class="pill" style="margin-top:12px">Spotify</div>
              <div data-slot="spotify" class="spotify-slot">Spotify player will load here</div>
              <div class="lead" data-slot="spotifyTitle" style="margin-top:6px"></div>
            </div>
            <div class="stats">
              <div class="stat"><span>Instagram followers</span> <b data-stat="instagramFollowers">0</b></div>
              <div class="stat"><span>Facebook followers</span> <b data-stat="facebookFollowers">0</b></div>
              <div class="stat"><span>Top YouTube video views</span> <b data-stat="youtubeViews">0</b></div>
              <div class="stat"><span>Artist Popularity Score on Spotify (0-100)</span> <b data-stat="spotifyPopularity">0</b></div>
              <div class="stat" style="display:block">
                <div class="pill">Bio</div>
                <p class="lead" data-slot="bio" style="margin:8px 0 0">${(b.bio||'').trim() || 'Bio will populate once connected.'}</p>
              </div>
            </div>
          </div>
        </article>`;
    }

    function renderBands(){
      const wrap = document.getElementById('bands');
      wrap.innerHTML = BANDS.sort(byName).map(bandCardHTML).join('');
    }

    /* ---------- live data ---------- */
    async function getJSON(u){
      try{ const r = await fetch(u); return await r.json(); }
      catch{ return null; }
    }

    async function loadBandLive(b){
      // YouTube top view count from FEATURED video only
      const yt = b.youtube ? await getJSON(`/api/youtube?url=${encodeURIComponent(b.youtube)}`) : null;

      // Popularity must come from a true ARTIST url only
      const artistUrl =
        (b.spotifyArtist && isSpotifyArtistUrl(b.spotifyArtist)) ? b.spotifyArtist :
        (b.spotify && isSpotifyArtistUrl(b.spotify)) ? b.spotify :
        null;

      const sp = artistUrl
        ? await getJSON(`/api/spotify-top?url=${encodeURIComponent(artistUrl)}&market=CY`)
        : null;

      // Build an embed URL from the exact track link you provided
      const tr = b.spotifyEmbedTrack ? toSpotifyEmbedTrack(b.spotifyEmbedTrack) : null;

      const prev = STATS[b.name] || {};
      STATS[b.name] = {
        ...prev,
        youtubeViews: yt?.views ?? prev.youtubeViews ?? 0,
        spotifyPopularity: sp?.popularity ?? prev.spotifyPopularity ?? 0,
        spotifyEmbed: tr?.embed || prev.spotifyEmbed || null,
        spotifyHref: tr?.href || prev.spotifyHref || null,
        trackName: sp?.trackName ?? prev.trackName ?? null
      };

      patchBandCard(b.name);
    }

    async function loadAllLive(){
      await Promise.all(BANDS.map(loadBandLive));
      renderBoards();
    }

    /* ---------- boot ---------- */
    document.getElementById('year').textContent = new Date().getFullYear();
    renderSummary();
    renderBands();
    applyManualStats();       // fill bios + manual counts
    patchAllCardsFromStats(); // show bios immediately
    renderBoards();
    loadAllLive();            // hydrate live metrics + spotify embed
  </script>
</body>
</html>
